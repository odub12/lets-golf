<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indians Hills Men's Club</title>
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" href="apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDOZdQs6bVI2jfyU62oL_9CrjkBhZChRlU",
            authDomain: "ihmc-golf.firebaseapp.com",
            projectId: "ihmc-golf",
            storageBucket: "ihmc-golf.firebasestorage.app",
            messagingSenderId: "275902581629",
            appId: "1:275902581629:web:3074712090e0d745d6da14"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
    
    <style>
        :root {
            --forest: #1a3a2f;
            --forest-deep: #0f2920;
            --forest-light: #2d5a4a;
            --gold: #c9a227;
            --gold-light: #e8c84a;
            --gold-muted: #a8892a;
            --cream: #f5f2eb;
            --cream-dark: #e8e4d9;
            --white: #ffffff;
            --text-dark: #1a1a1a;
            --text-muted: #5a5a5a;
            --success: #2d7a4f;
            --error: #c44536;
            --shadow-sm: 0 2px 8px rgba(26, 58, 47, 0.08);
            --shadow-md: 0 4px 20px rgba(26, 58, 47, 0.12);
            --shadow-lg: 0 8px 40px rgba(26, 58, 47, 0.16);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans 3', sans-serif;
            background: var(--cream);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--forest-deep) 0%, var(--forest) 50%, var(--forest-light) 100%);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 3rem;
            border-bottom: 1px solid rgba(201, 162, 39, 0.2);
            position: relative;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-img {
            height: 60px;
            width: auto;
            border-radius: var(--radius-sm);
        }

        .logo-text {
            font-family: 'Playfair Display', serif;
            color: var(--white);
        }

        .logo-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .logo-text span {
            font-size: 0.75rem;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        nav {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }

        nav button {
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--cream);
            padding: 0.75rem 1.25rem;
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.5px;
        }

        nav button:hover {
            color: var(--gold);
        }

        nav button.active {
            color: var(--gold);
            border-bottom: 2px solid var(--gold);
            background: transparent;
        }
        
        .profile-bell-group {
            display: flex;
            align-items: center;
            position: relative;
            gap: 0;
        }
        
        .profile-bell-group button[data-view="profile"] {
            padding-right: 0.25rem;
        }
        
        .admin-btn {
            display: none;
            background: #c41e3a;
            color: white !important;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            font-weight: 600;
            text-decoration: none;
            font-size: 0.85rem;
            margin-left: 1rem;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .admin-btn::before {
            content: '';
            position: absolute;
            left: -0.75rem;
            top: 50%;
            transform: translateY(-50%);
            height: 1.25rem;
            width: 1px;
            background: var(--gold-muted);
        }
        
        .admin-btn:hover {
            background: #a01830;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
            padding: 4rem 3rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c9a227' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5;
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .hero h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: var(--white);
            margin-bottom: 0.5rem;
        }

        .hero p {
            color: var(--gold-light);
            font-size: 1.1rem;
            font-weight: 300;
        }

        /* Main Content */
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gold);
        }

        .section-header h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            color: var(--forest);
        }

        .filter-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .filter-tab {
            background: var(--white);
            border: 1px solid var(--cream-dark);
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--radius-sm);
            font-family: 'Source Sans 3', sans-serif;
        }

        .filter-tab:hover {
            border-color: var(--gold);
        }

        .filter-tab.active {
            background: var(--forest);
            color: var(--white);
            border-color: var(--forest);
        }

        /* Events Grid */
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 1.5rem;
        }

        .event-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            border: 1px solid var(--cream-dark);
        }

        .event-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
        }

        .event-card-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #8B7355 0%, #C9A227 50%, #D4AF37 100%);
            position: relative;
        }

        .event-card-header.scramble {
            background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
        }

        .event-card-header .event-title h4,
        .event-card-header .event-title p {
            color: var(--forest-deep);
        }

        .event-card-header .event-title p {
            opacity: 0.8;
        }

        .event-card-header.scramble .event-title h4,
        .event-card-header.scramble .event-title p {
            color: var(--white);
        }

        .event-card-header.scramble .event-title p {
            color: var(--gold-light);
            opacity: 0.9;
        }

        .event-type-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--gold);
            color: var(--forest-deep);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .event-type-badge.scramble {
            background: var(--cream);
        }

        .event-date {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .date-box {
            background: var(--white);
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            text-align: center;
            min-width: 70px;
        }

        .date-box .month {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--gold-muted);
            font-weight: 600;
            letter-spacing: 1px;
        }

        .date-box .day {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--forest);
            line-height: 1;
        }

        .date-box .weekday {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .event-title {
            color: var(--white);
        }

        .event-title h4 {
            font-family: 'Playfair Display', serif;
            font-size: 1.35rem;
            margin-bottom: 0.25rem;
        }

        .event-title p {
            font-size: 0.85rem;
            color: var(--gold-light);
            opacity: 0.9;
        }

        .event-card-body {
            padding: 1.5rem;
        }

        .event-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .detail-icon {
            width: 32px;
            height: 32px;
            background: var(--cream);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .detail-text {
            font-size: 0.85rem;
        }

        .detail-text span {
            display: block;
            color: var(--text-muted);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-card-footer {
            padding: 1rem 1.5rem;
            background: var(--cream);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--cream-dark);
        }

        .spots-remaining {
            font-size: 0.85rem;
        }

        .spots-remaining strong {
            color: var(--forest);
        }

        .spots-remaining.low {
            color: var(--error);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: var(--gold);
            color: var(--forest-deep);
        }

        .btn-primary:hover {
            background: var(--gold-light);
        }

        .btn-secondary {
            background: var(--forest);
            color: var(--white);
        }

        .btn-secondary:hover {
            background: var(--forest-light);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--forest);
            color: var(--forest);
        }

        .btn-outline:hover {
            background: var(--forest);
            color: var(--white);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 41, 32, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--white);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
            position: relative;
        }

        .modal-header h3 {
            font-family: 'Playfair Display', serif;
            color: var(--white);
            font-size: 1.5rem;
        }

        .modal-header p {
            color: var(--gold-light);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--white);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 2rem;
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .form-section:last-child {
            margin-bottom: 0;
        }

        .form-section h4 {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            color: var(--forest);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--cream-dark);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--cream-dark);
            border-radius: var(--radius-sm);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: var(--white);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.1);
        }

        .team-member-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.75rem;
            align-items: end;
            padding: 1rem;
            background: var(--cream);
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
        }

        .team-member-row .form-group {
            margin-bottom: 0;
        }

        .member-number {
            background: var(--forest);
            color: var(--white);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .remove-member {
            background: var(--error);
            color: var(--white);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .remove-member:hover {
            background: #a33a2d;
        }

        .add-member-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--cream);
            border: 2px dashed var(--gold-muted);
            border-radius: var(--radius-md);
            color: var(--forest);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-member-btn:hover {
            background: var(--cream-dark);
            border-color: var(--gold);
        }

        .add-member-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            background: var(--cream);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--cream-dark);
        }

        .registration-total {
            font-size: 1.1rem;
        }

        .registration-total strong {
            color: var(--forest);
            font-size: 1.5rem;
        }

        /* Member Directory Dropdown */
        .member-select-wrapper {
            position: relative;
        }

        .member-search {
            position: relative;
        }

        .member-search input {
            padding-right: 2.5rem;
        }

        .member-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--cream-dark);
            border-radius: var(--radius-sm);
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: var(--shadow-md);
            display: none;
        }

        .member-dropdown.active {
            display: block;
        }

        .member-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--cream);
        }

        .member-option:last-child {
            border-bottom: none;
        }

        .member-option:hover {
            background: var(--cream);
        }

        .member-option .name {
            font-weight: 500;
        }

        .member-option .handicap {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Success State */
        .registration-success {
            text-align: center;
            padding: 3rem 2rem;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2.5rem;
            color: var(--white);
        }

        .registration-success h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            color: var(--forest);
            margin-bottom: 0.5rem;
        }

        .registration-success p {
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .confirmation-details {
            background: var(--cream);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            text-align: left;
            margin-bottom: 2rem;
        }

        .confirmation-details h4 {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .confirmation-details .team-list {
            list-style: none;
        }

        .confirmation-details .team-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--cream-dark);
            display: flex;
            justify-content: space-between;
        }

        .confirmation-details .team-list li:last-child {
            border-bottom: none;
        }

        /* My Registrations Section */
        .my-registrations {
            margin-top: 3rem;
        }

        .registration-card {
            background: var(--white);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--gold);
        }

        .registration-info h4 {
            font-family: 'Playfair Display', serif;
            color: var(--forest);
            margin-bottom: 0.25rem;
        }

        .registration-info p {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .registration-team {
            display: flex;
            gap: 0.5rem;
        }

        .team-avatar {
            width: 36px;
            height: 36px;
            background: var(--forest);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Admin Panel */
        .admin-section {
            display: none;
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .admin-section.active {
            display: block;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gold);
        }

        .admin-header h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--forest);
        }

        .event-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .event-form .form-group.full-width {
            grid-column: span 2;
        }

        /* Quick Links Grid */
        .quick-links-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .quick-link-card {
            background: var(--white);
            border: 2px solid var(--cream-dark);
            border-radius: var(--radius-lg);
            padding: 1.5rem 1rem;
            text-align: center;
            text-decoration: none;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            font-family: 'Source Sans 3', sans-serif;
        }

        .quick-link-card:hover {
            border-color: var(--gold);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .quick-link-icon {
            font-size: 2rem;
        }

        .quick-link-title {
            font-weight: 600;
            color: var(--forest);
            font-size: 1rem;
        }

        .quick-link-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Info Sections */
        .info-section {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .info-section h4 {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            color: var(--forest);
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--gold);
        }

        /* Contact Form */
        .contact-form {
            max-width: 600px;
        }

        .contact-form .form-group {
            margin-bottom: 1rem;
        }

        .contact-form label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .contact-form select,
        .contact-form textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--cream-dark);
            border-radius: var(--radius-sm);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 1rem;
        }

        .contact-form select:focus,
        .contact-form textarea:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.1);
        }

        /* Documents Grid */
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .document-card {
            background: var(--cream);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .document-card:hover {
            background: var(--cream-dark);
            transform: translateY(-2px);
        }

        .doc-icon {
            font-size: 2rem;
        }

        .doc-title {
            font-weight: 600;
            color: var(--forest);
        }

        .doc-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Calendar Styles */
        .calendar-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .calendar-nav h4 {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--forest);
            min-width: 200px;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .calendar-header {
            text-align: center;
            font-weight: 600;
            color: var(--forest);
            padding: 0.5rem;
            font-size: 0.85rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            padding: 0.25rem;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            min-height: 90px;
            background: var(--cream);
            position: relative;
            overflow: hidden;
        }

        .calendar-day.other-month {
            background: transparent;
            color: var(--text-muted);
            opacity: 0.5;
        }

        .calendar-day.today {
            outline: 3px solid var(--gold);
            outline-offset: -3px;
        }

        .calendar-day .day-number {
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
            text-align: center;
        }

        .calendar-day .day-events {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
        }

        .calendar-day.has-event {
            padding: 0;
        }

        .calendar-day.has-event .day-number {
            padding: 0.25rem;
            background: rgba(255,255,255,0.9);
            margin: 0;
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        }

        .calendar-event {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem;
            border-radius: 0 0 var(--radius-sm) var(--radius-sm);
            cursor: pointer;
            line-height: 1.2;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        .calendar-event.tournament {
            background: var(--gold);
            color: var(--forest-deep);
        }

        .calendar-event.scramble {
            background: var(--forest);
            color: var(--white);
        }

        .calendar-legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            padding: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-dot.tournament {
            background: var(--gold);
        }

        .legend-dot.scramble {
            background: var(--forest);
        }

        /* Events Controls */
        .events-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .view-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        /* Course Info Page */
        .course-info-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .course-info-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .course-header {
            background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
            padding: 1.5rem;
            text-align: center;
        }

        .course-header h4 {
            color: var(--white);
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            margin: 0;
        }

        .course-links {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .course-link-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            background: var(--cream);
            border: none;
            border-radius: var(--radius-md);
            text-decoration: none;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Source Sans 3', sans-serif;
            font-size: 1rem;
            text-align: left;
            width: 100%;
        }

        .course-link-btn:hover {
            background: var(--cream-dark);
            transform: translateX(4px);
        }

        .course-link-btn .link-icon {
            font-size: 1.25rem;
            width: 30px;
            text-align: center;
        }

        .course-link-btn .link-text {
            flex: 1;
            font-weight: 500;
        }

        .course-link-btn .link-arrow {
            color: var(--gold);
            font-size: 1.1rem;
        }

        .course-emails {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--cream-dark);
        }

        .course-emails h5 {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .email-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            color: var(--forest);
            text-decoration: none;
            font-size: 0.95rem;
        }

        .email-link:hover {
            color: var(--gold);
        }

        /* Payment Options in Modal */
        .payment-options-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .payment-option-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--cream);
            border-radius: var(--radius-md);
            text-decoration: none;
            color: var(--text-dark);
            transition: all 0.2s ease;
        }

        .payment-option-row:hover {
            background: var(--cream-dark);
            transform: translateX(4px);
        }

        .payment-option-row .payment-logo {
            font-size: 1.5rem;
        }

        .payment-option-row .payment-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .payment-option-row .payment-name {
            font-weight: 600;
            color: var(--forest);
        }

        .payment-option-row .payment-id {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .payment-option-row .payment-arrow {
            color: var(--gold);
            font-size: 1.25rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                gap: 0.75rem;
                padding: 1rem;
                position: relative;
            }

            nav {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.1rem;
                width: 100%;
            }
            
            nav button {
                padding: 0.5rem 0.7rem;
                font-size: 0.8rem;
            }
            
            .profile-bell-group {
                display: flex;
                align-items: center;
            }
            
            .profile-bell-group button[data-view="profile"] {
                padding-right: 0.2rem;
            }
            
            .notification-bell {
                font-size: 0.85rem;
                padding: 0.5rem 0.3rem;
            }
            
            .notification-dropdown {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                max-height: 60vh;
                border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            }
            
            .admin-btn {
                position: absolute;
                top: 1rem;
                right: 0.5rem;
                padding: 0.35rem 0.6rem;
                font-size: 0.7rem;
                margin-left: 0;
            }
            
            .admin-btn::before {
                display: none;
            }
            
            /* Events controls mobile */
            .events-controls {
                flex-direction: column;
                align-items: stretch;
                width: 100%;
            }
            
            .view-toggle {
                justify-content: center;
            }
            
            .hero h2 {
                font-size: 2rem;
            }
            
            .hero p {
                font-size: 1rem;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .filter-tabs {
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            
            .filter-tabs::-webkit-scrollbar {
                display: none;
            }
            
            .filter-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
                white-space: nowrap;
            }

            main {
                padding: 1.5rem;
            }

            .events-grid {
                grid-template-columns: 1fr;
            }

            .event-details {
                grid-template-columns: 1fr 1fr;
            }

            .modal {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
            }
            
            .modal-overlay {
                padding: 1rem;
            }

            .event-form {
                grid-template-columns: 1fr;
            }

            .event-form .form-group.full-width {
                grid-column: span 1;
            }

            .registration-card {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            /* Info page mobile */
            .quick-links-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .documents-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-day {
                min-height: 60px;
                padding: 0.25rem;
            }
            
            .calendar-day .day-number {
                font-size: 0.8rem;
            }
            
            .calendar-event {
                font-size: 0.55rem;
                padding: 1px 2px;
            }
            
            .calendar-nav h4 {
                font-size: 1.1rem;
                min-width: 140px;
            }
        }
        
        @media (max-width: 480px) {
            nav {
                gap: 0;
            }
            
            nav button {
                padding: 0.45rem 0.5rem;
                font-size: 0.72rem;
            }
            
            .logo-img {
                height: 50px;
            }
            
            .admin-btn {
                padding: 0.35rem 0.5rem;
                font-size: 0.7rem;
            }
            
            .hero {
                padding: 2.5rem 1.5rem;
            }
            
            .hero h2 {
                font-size: 1.75rem;
            }
            
            .event-details {
                grid-template-columns: 1fr;
            }
            
            .section-header h3 {
                font-size: 1.5rem;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h4 {
            font-family: 'Playfair Display', serif;
            color: var(--forest);
            margin-bottom: 0.5rem;
        }

        /* Profile Styles */
        .profile-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            max-width: 600px;
        }

        .profile-header {
            background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
            padding: 2rem;
            text-align: center;
            color: var(--white);
        }

        .profile-avatar-wrapper {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto 1rem;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--forest-deep);
        }

        .profile-avatar-img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--gold);
        }

        .profile-photo-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 32px;
            height: 32px;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            border: 2px solid var(--white);
            transition: transform 0.2s;
        }

        .profile-photo-edit:hover {
            transform: scale(1.1);
        }

        .profile-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            margin-bottom: 0.25rem;
        }

        .profile-header p {
            color: var(--gold-light);
            font-size: 0.9rem;
        }

        .profile-details {
            padding: 1.5rem 2rem;
        }

        .profile-row {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--cream-dark);
        }

        .profile-row:last-child {
            border-bottom: none;
        }

        .profile-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .profile-value {
            font-weight: 600;
            color: var(--forest);
        }

        .profile-quick-links {
            padding: 1rem 2rem;
            display: flex;
            gap: 1rem;
            border-top: 1px solid var(--cream-dark);
        }

        .profile-quick-link {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--cream);
            border: none;
            border-radius: var(--radius-md);
            color: var(--forest);
            text-decoration: none;
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .profile-quick-link:hover {
            background: var(--cream-dark);
        }

        .profile-actions {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--cream-dark);
            display: flex;
            gap: 1rem;
        }

        .login-prompt {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 3rem;
            text-align: center;
            box-shadow: var(--shadow-sm);
            max-width: 500px;
        }

        .login-prompt h3 {
            font-family: 'Playfair Display', serif;
            color: var(--forest);
            margin-bottom: 1rem;
        }

        .login-prompt p {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.paid {
            background: #d4edda;
            color: #155724;
        }

        /* Winner Cards */
        .winner-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            margin-bottom: 1rem;
            border: 1px solid var(--cream-dark);
        }

        .winner-header {
            padding: 1.25rem 1.5rem;
            background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .winner-event h4 {
            font-family: 'Playfair Display', serif;
            color: var(--white);
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }

        .winner-event p {
            color: var(--gold-light);
            font-size: 0.85rem;
        }

        .winner-trophy {
            font-size: 2.5rem;
        }

        .winner-results {
            padding: 1.5rem;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .winner-category {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .category-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
        }

        .winner-name {
            font-weight: 600;
            color: var(--forest);
            font-size: 1.1rem;
        }

        .winner-score {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gold-muted);
        }

        /* Payment Info Section */
        .payment-section {
            background: var(--cream);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 2px dashed var(--gold);
        }

        .payment-section h4 {
            font-family: 'Playfair Display', serif;
            color: var(--forest);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .payment-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .payment-option {
            background: var(--white);
            padding: 1rem;
            border-radius: var(--radius-sm);
            text-align: center;
            border: 1px solid var(--cream-dark);
        }

        .payment-option .payment-logo {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .payment-option .payment-name {
            font-weight: 600;
            color: var(--forest);
            font-size: 0.9rem;
        }

        .payment-option .payment-id {
            font-size: 0.85rem;
            color: var(--text-muted);
            word-break: break-all;
        }

        @media (max-width: 768px) {
            .payment-options {
                grid-template-columns: 1fr;
            }
            
            .winner-results {
                grid-template-columns: 1fr;
            }
        }
        }

        /* Message Styles */
        .message-card {
            background: var(--white);
            border-radius: var(--radius-md);
            padding: 1.25rem 1.5rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid var(--cream-dark);
        }

        .message-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        .message-card.unread {
            border-left-color: var(--gold);
            background: linear-gradient(135deg, var(--white) 0%, rgba(201, 162, 39, 0.05) 100%);
        }

        .message-card.unread .message-subject {
            font-weight: 600;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .message-from {
            font-weight: 500;
            color: var(--forest);
        }

        .message-date {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .message-subject {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }

        .message-preview {
            font-size: 0.9rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-badge {
            background: var(--gold);
            color: var(--forest-deep);
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            margin-left: 0.5rem;
        }

        .nav-badge {
            background: var(--gold);
            color: var(--forest-deep);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.1rem 0.4rem;
            border-radius: 8px;
            margin-left: 0.35rem;
            vertical-align: super;
        }

        /* Notification Bell */
        .notification-bell {
            background: transparent;
            border: none;
            color: var(--cream);
            font-size: 0.95rem;
            cursor: pointer;
            padding: 0.5rem 0.5rem;
            position: relative;
            transition: all 0.2s ease;
        }

        .notification-bell:hover {
            color: var(--gold);
            transform: scale(1.1);
        }

        .notification-bell .bell-badge {
            position: absolute;
            top: 2px;
            right: 0;
            background: var(--error);
            color: white;
            font-size: 0.55rem;
            font-weight: 700;
            min-width: 14px;
            height: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1.5px solid var(--forest-deep);
        }

        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 320px;
            max-height: 400px;
            background: var(--white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 200;
            display: none;
            overflow: hidden;
        }

        .notification-dropdown.active {
            display: block;
        }

        .notification-header {
            padding: 1rem;
            background: var(--forest);
            color: var(--white);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header button {
            background: transparent;
            border: none;
            color: var(--gold-light);
            font-size: 0.8rem;
            cursor: pointer;
        }

        .notification-header button:hover {
            text-decoration: underline;
        }

        .notification-list {
            max-height: 320px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid var(--cream);
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: var(--cream);
        }

        .notification-item.unread {
            background: rgba(201, 162, 39, 0.08);
            border-left: 3px solid var(--gold);
        }

        .notification-item .notif-icon {
            font-size: 1.5rem;
            margin-right: 0.75rem;
            float: left;
        }

        .notification-item .notif-content {
            overflow: hidden;
        }

        .notification-item .notif-title {
            font-weight: 500;
            color: var(--forest);
            margin-bottom: 0.25rem;
        }

        .notification-item .notif-body {
            font-size: 0.85rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .notification-item .notif-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .notification-empty {
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
        }

        .recipient-checkbox {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid var(--cream);
            cursor: pointer;
        }

        .recipient-checkbox:hover {
            background: var(--cream);
        }

        .recipient-checkbox:last-child {
            border-bottom: none;
        }

        .recipient-checkbox input {
            margin-right: 0.75rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .recipient-checkbox label {
            cursor: pointer;
            flex: 1;
        }

        .message-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .message-tab {
            background: var(--white);
            border: 1px solid var(--cream-dark);
            padding: 0.6rem 1.25rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--radius-sm);
        }

        .message-tab:hover {
            background: var(--cream);
        }

        .message-tab.active {
            background: var(--forest);
            color: var(--white);
            border-color: var(--forest);
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--cream);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 2000;
        }

        .toast {
            background: var(--forest);
            color: var(--white);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            margin-top: 0.5rem;
            animation: toastSlide 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--error);
        }

        @keyframes toastSlide {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-top">
            <div class="logo">
                <img src="IHMC_logo.jpg" alt="Indian Hills Men's Club" class="logo-img">
            </div>
            <nav>
                <button data-view="course-info">Course</button>
                <button data-view="info">Club Info</button>
                <button class="active" data-view="events">Events</button>
                <button data-view="past-winners">Winners</button>
                <button data-view="my-registrations">My Regs</button>
                <button data-view="messages" id="messages-nav-btn">Messages</button>
                <div class="profile-bell-group">
                    <button data-view="profile" id="profile-nav-btn">Profile</button>
                    <button class="notification-bell" onclick="toggleNotifications(event)" id="notification-bell" style="display: none;">
                        
                        <span class="bell-badge" id="notification-badge" style="display: none;">0</span>
                    </button>
                    <div class="notification-dropdown" id="notification-dropdown">
                        <div class="notification-header">
                            <span>Notifications</span>
                            <button onclick="markAllNotificationsRead()">Mark all read</button>
                        </div>
                        <div class="notification-list" id="notification-list">
                            <!-- Notifications will be populated here -->
                        </div>
                    </div>
                </div>
                <a href="ihmc.admin.html" id="admin-nav-btn" class="admin-btn">Admin</a>
            </nav>
        </div>
    </header>

    <div class="hero">
        <div class="hero-content">
            <h2>2026 Season</h2>
            <p>Monthly tournaments & Sunday scrambles  Register your team today</p>
        </div>
    </div>

    <main>
        <!-- Events View -->
        <section id="events-view" class="view active">
            <div class="section-header">
                <h3>Upcoming Events</h3>
                <div class="events-controls">
                    <button class="btn btn-outline view-toggle" id="calendar-toggle-btn" onclick="toggleEventsView()">
                         Calendar View
                    </button>
                    <div class="filter-tabs">
                        <button class="filter-tab active" data-filter="all">All Events</button>
                        <button class="filter-tab" data-filter="tournament">Tournaments</button>
                        <button class="filter-tab" data-filter="scramble">Sunday Scrambles</button>
                    </div>
                </div>
            </div>
            <div id="events-list-view">
                <div class="events-grid" id="events-grid">
                    <!-- Events will be populated by JavaScript -->
                </div>
            </div>
            <div id="events-calendar-view" style="display: none;">
                <div class="calendar-nav">
                    <button class="btn btn-outline" onclick="changeCalendarMonth(-1)"> Prev</button>
                    <h4 id="calendar-month-title">January 2026</h4>
                    <button class="btn btn-outline" onclick="changeCalendarMonth(1)">Next </button>
                </div>
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Calendar will be populated by JavaScript -->
                </div>
                <div class="calendar-legend">
                    <span class="legend-item"><span class="legend-dot scramble"></span> Sunday Scramble</span>
                    <span class="legend-item"><span class="legend-dot tournament"></span> Tournament</span>
                </div>
            </div>
        </section>

        <!-- Past Winners View -->
        <section id="past-winners-view" class="view" style="display: none;">
            <div class="section-header">
                <h3>Past Winners</h3>
                <div class="filter-tabs">
                    <button class="filter-tab active" data-filter="all-winners">All</button>
                    <button class="filter-tab" data-filter="2026">2026</button>
                    <button class="filter-tab" data-filter="2025">2025</button>
                </div>
            </div>
            <div id="past-winners-list">
                <!-- Past winners will be populated by JavaScript -->
            </div>
        </section>

        <!-- My Registrations View -->
        <section id="my-registrations-view" class="view" style="display: none;">
            <div class="section-header">
                <h3>My Registrations</h3>
            </div>
            <div id="my-registrations-list">
                <!-- Registrations will be populated by JavaScript -->
            </div>
        </section>
        
        <!-- Messages View -->
        <section id="messages-view" class="view" style="display: none;">
            <div class="section-header">
                <h3>Messages</h3>
                <button class="btn btn-primary" onclick="openComposeModal()" id="compose-btn" style="display: none;">
                     New Message
                </button>
            </div>
            <div id="messages-content">
                <!-- Messages will be populated by JavaScript -->
            </div>
        </section>
        
        <!-- Profile View -->
        <section id="profile-view" class="view" style="display: none;">
            <div class="section-header">
                <h3>My Profile</h3>
            </div>
            <div id="profile-content">
                <!-- Will be populated by JavaScript based on login state -->
            </div>
        </section>
        
        <!-- Course Info View (NEW) -->
        <section id="course-info-view" class="view" style="display: none;">
            <div class="section-header">
                <h3>Course Info</h3>
            </div>
            
            <div class="course-info-content">
                <div class="course-info-card">
                    <div class="course-header">
                        <h4> Indian Hills Golf Course</h4>
                    </div>
                    
                    <div class="course-links">
                        <a href="https://www.indianhillsgolf.com" target="_blank" class="course-link-btn">
                            <span class="link-icon"></span>
                            <span class="link-text">Golf Course Website</span>
                            <span class="link-arrow"></span>
                        </a>
                        <a href="https://www.indianhillsgolf.com/request_tt/" target="_blank" class="course-link-btn">
                            <span class="link-icon"></span>
                            <span class="link-text">Book a Tee Time</span>
                            <span class="link-arrow"></span>
                        </a>
                        <a href="tel:9516272550" class="course-link-btn">
                            <span class="link-icon"></span>
                            <span class="link-text">(951) 627-2550</span>
                            <span class="link-arrow"></span>
                        </a>
                        <button class="course-link-btn" onclick="copyAddress()">
                            <span class="link-icon"></span>
                            <span class="link-text">5700 Club House Dr, Riverside, CA 92509</span>
                            <span class="link-arrow"></span>
                        </button>
                    </div>
                    
                    <div class="course-emails">
                        <h5>Email Contacts</h5>
                        <a href="mailto:events@indianhillsgolf.com" class="email-link">
                            <span></span> events@indianhillsgolf.com
                        </a>
                        <a href="mailto:tournaments@indianhillsgolf.com" class="email-link">
                            <span></span> tournaments@indianhillsgolf.com
                        </a>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Club Info View (renamed from Info) -->
        <section id="info-view" class="view" style="display: none;">
            <div class="section-header">
                <h3>Club Info</h3>
            </div>
            
            <!-- Documents Section (FIRST) -->
            <div class="info-section">
                <h4> Documents & Rules</h4>
                <div class="documents-grid">
                    <div class="document-card" onclick="showLocalRules()">
                        <span class="doc-icon"></span>
                        <span class="doc-title">Local Rules</span>
                        <span class="doc-desc">Indian Hills course rules</span>
                    </div>
                    <div class="document-card" onclick="showBylaws()">
                        <span class="doc-icon"></span>
                        <span class="doc-title">Club Bylaws</span>
                        <span class="doc-desc">IHMC constitution</span>
                    </div>
                    <a href="https://www.usga.org/rules/rules-and-clarifications/rules-of-golf.html" target="_blank" class="document-card">
                        <span class="doc-icon"></span>
                        <span class="doc-title">USGA Rules</span>
                        <span class="doc-desc">Official rules of golf</span>
                    </a>
                </div>
            </div>
            
            <!-- Contact/Suggestion Form (SECOND) -->
            <div class="info-section">
                <h4> Contact Us / Suggestions</h4>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">Have a question or suggestion? Send it to the right person.</p>
                <div class="contact-form">
                    <div class="form-group">
                        <label>What's this about?</label>
                        <select id="contact-category">
                            <option value="">Select a category...</option>
                            <option value="tournament">Tournament / Events</option>
                            <option value="membership">Membership</option>
                            <option value="dues">Dues / Payments</option>
                            <option value="general">General Question</option>
                            <option value="suggestion">Suggestion</option>
                        </select>
                    </div>
                    <div class="form-group" id="anonymous-option" style="display: none;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="contact-anonymous">
                            Submit anonymously
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Your Message</label>
                        <textarea id="contact-message" rows="4" placeholder="Type your message here..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="submitContactForm()">Send Message</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Pay Dues Modal -->
    <div class="modal-overlay" id="pay-dues-modal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3> Pay Dues</h3>
                <p>Choose your payment method</p>
                <button class="modal-close" onclick="closePayDuesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="payment-options-list">
                    <a href="#" class="payment-option-row" id="venmo-link">
                        <span class="payment-logo"></span>
                        <div class="payment-info">
                            <span class="payment-name">Venmo</span>
                            <span class="payment-id">Coming soon</span>
                        </div>
                        <span class="payment-arrow"></span>
                    </a>
                    <a href="#" class="payment-option-row" id="paypal-link">
                        <span class="payment-logo"></span>
                        <div class="payment-info">
                            <span class="payment-name">PayPal</span>
                            <span class="payment-id">Coming soon</span>
                        </div>
                        <span class="payment-arrow"></span>
                    </a>
                    <a href="#" class="payment-option-row" id="zelle-link">
                        <span class="payment-logo"></span>
                        <div class="payment-info">
                            <span class="payment-name">Zelle</span>
                            <span class="payment-id">Coming soon</span>
                        </div>
                        <span class="payment-arrow"></span>
                    </a>
                </div>
                <p style="text-align: center; color: var(--text-muted); font-size: 0.85rem; margin-top: 1rem;">
                    Include your name in the payment memo
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closePayDuesModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Local Rules Modal -->
    <div class="modal-overlay" id="local-rules-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3> Local Rules</h3>
                <p>Indian Hills Golf Course</p>
                <button class="modal-close" onclick="closeLocalRulesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="local-rules-content" style="line-height: 1.8;">
                    <p style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        Local rules coming soon.<br>Check back later!
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeLocalRulesModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Bylaws Modal -->
    <div class="modal-overlay" id="bylaws-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3> Club Bylaws</h3>
                <p>Indian Hills Men's Club Constitution</p>
                <button class="modal-close" onclick="closeBylawsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="bylaws-content" style="line-height: 1.8;">
                    <p style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        Club bylaws coming soon.<br>Check back later!
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeBylawsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal-overlay" id="login-modal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3>Sign In</h3>
                <p>Enter the last 4 digits of your GHIN number</p>
                <button class="modal-close" onclick="closeLoginModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <div class="form-group">
                        <label>Last 4 digits of GHIN</label>
                        <input type="text" id="login-ghin" placeholder="e.g., 1790" maxlength="4" autocomplete="off" inputmode="numeric" style="font-size: 1.5rem; text-align: center; letter-spacing: 0.5rem;">
                    </div>
                    <div id="login-lastname-group" class="form-group" style="display: none;">
                        <label>Last Name</label>
                        <input type="text" id="login-lastname" placeholder="Enter your last name" autocomplete="off">
                    </div>
                    <div id="login-error" style="color: var(--error); font-size: 0.85rem; margin-top: 0.5rem; display: none;"></div>
                    <div id="login-confirm" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--cream); border-radius: var(--radius-md);">
                        <p style="margin-bottom: 0.5rem;">Is this you?</p>
                        <p style="font-size: 1.25rem; font-weight: 600; color: var(--forest);" id="login-confirm-name"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeLoginModal()">Cancel</button>
                <button class="btn btn-primary" id="login-btn" onclick="handleLogin()">Find Me</button>
            </div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div class="modal-overlay" id="registration-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-event-name">Event Name</h3>
                <p id="modal-event-date">Date & Time</p>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <div id="registration-form-container">
                    <div class="form-section">
                        <h4>Player 1 (You)</h4>
                        <div class="form-group">
                            <label>Your Name</label>
                            <div class="member-select-wrapper">
                                <div class="member-search">
                                    <input type="text" 
                                        id="player1-name" 
                                        required
                                        placeholder="Search members..."
                                        oninput="filterPlayer1()"
                                        onfocus="showPlayer1Dropdown()"
                                        autocomplete="off">
                                </div>
                                <div class="member-dropdown" id="player1-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-section" id="teammates-section">
                        <h4 id="teammates-title">Your Team</h4>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;" id="teammates-description">Select your teammates or leave blank for TD to assign</p>
                        <div id="team-members-container">
                            <!-- Team member inputs will be added here -->
                        </div>
                        <button type="button" class="add-member-btn" id="add-member-btn" onclick="addTeamMember()">
                            + Add Teammate
                        </button>
                    </div>
                    <div class="form-section">
                        <h4>Tee Time Preference</h4>
                        <div class="form-group">
                            <select id="tee-time-preference">
                                <option value="no-preference">No Preference</option>
                                <option value="first-off">First Off</option>
                                <option value="earlier">Earlier Time</option>
                                <option value="later">Later Time</option>
                                <option value="last-off">Last Off</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-section">
                        <h4>Notes to Tournament Director</h4>
                        <div class="form-group">
                            <textarea id="registration-notes" rows="3" placeholder="Any special requests or information..." style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--cream-dark); border-radius: var(--radius-sm); font-family: 'Source Sans 3', sans-serif; font-size: 1rem; resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>
                <div id="registration-success-container" style="display: none;">
                    <!-- Success message will be shown here -->
                </div>
            </div>
            <div class="modal-footer" id="modal-footer">
                <div class="registration-total">
                    Total: <strong id="registration-total">$0</strong>
                </div>
                <button class="btn btn-primary" id="submit-registration" onclick="submitRegistration()">
                    Complete Registration
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal-overlay" id="edit-profile-modal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3>Edit Profile</h3>
                <p>Update your contact information</p>
                <button class="modal-close" onclick="closeEditProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="edit-profile-name" placeholder="First Last">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="edit-profile-email" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="edit-profile-phone" placeholder="(555) 123-4567">
                    </div>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 1rem;">
                        Note: GHIN, handicap, and membership info can only be updated by the Tournament Director.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeEditProfileModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProfileEdits()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Compose Message Modal -->
    <div class="modal-overlay" id="compose-modal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h3>New Message</h3>
                <p>Send a message to members</p>
                <button class="modal-close" onclick="closeComposeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <div class="form-group">
                        <label>To</label>
                        <select id="compose-recipient-type" onchange="handleRecipientTypeChange()">
                            <option value="individual">Individual Member</option>
                            <option value="group">Select Multiple</option>
                            <option value="all">All Members</option>
                        </select>
                    </div>
                    <div class="form-group" id="individual-recipient-group">
                        <label>Select Member</label>
                        <div class="member-select-wrapper">
                            <div class="member-search">
                                <input type="text" 
                                    id="compose-recipient-search" 
                                    placeholder="Search members..."
                                    oninput="filterComposeRecipients()"
                                    onfocus="showComposeRecipientDropdown()"
                                    autocomplete="off">
                            </div>
                            <div class="member-dropdown" id="compose-recipient-dropdown"></div>
                        </div>
                    </div>
                    <div class="form-group" id="group-recipient-group" style="display: none;">
                        <label>Select Members</label>
                        <div id="group-recipient-list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--cream-dark); border-radius: var(--radius-sm); padding: 0.5rem;">
                            <!-- Checkboxes will be populated here -->
                        </div>
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                            <span id="selected-count">0</span> members selected
                        </p>
                    </div>
                    <div class="form-group">
                        <label>Subject</label>
                        <input type="text" id="compose-subject" placeholder="Message subject..." maxlength="100">
                    </div>
                    <div class="form-group">
                        <label>Message</label>
                        <textarea id="compose-body" rows="5" placeholder="Type your message here..." style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--cream-dark); border-radius: var(--radius-sm); font-family: 'Source Sans 3', sans-serif; font-size: 1rem; resize: vertical;"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeComposeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="sendMessage()">Send Message</button>
            </div>
        </div>
    </div>

    <!-- View Message Modal -->
    <div class="modal-overlay" id="view-message-modal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h3 id="view-message-subject">Subject</h3>
                <p id="view-message-meta">From  Date</p>
                <button class="modal-close" onclick="closeViewMessageModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="view-message-body" style="white-space: pre-wrap; line-height: 1.6;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeViewMessageModal()">Close</button>
                <button class="btn btn-primary" onclick="replyToMessage()" id="reply-btn">Reply</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // Member directory (will be loaded from Firebase)
        let memberDirectory = [];
        
        // Current logged in user
        let currentUser = null;
        
        // Messages data
        let messages = [];
        let currentMessageTab = 'inbox';
        let selectedRecipients = [];
        let currentViewingMessage = null;
        
        // Admin GHIN numbers (last 4 digits for matching)
        const ADMIN_GHINS = [
            '11466790',  // Otis Williams
            '9329109',   // Chuck Bischoff (President)
            '9279734',   // Junior Cortes
            '8690635',   // Ken Williams (Vice President)
            '9074433',   // Eli Montoya (Treasurer)
            '11191724',  // Travis Lamb
            '1484089',   // Norm Herbert
            '9642645'    // Mike Haskins (Tournament Director)
        ];
        
        // Check if current user is admin
        function isAdmin() {
            if (!currentUser || !currentUser.ghin) return false;
            return ADMIN_GHINS.includes(currentUser.ghin);
        }
        
        // Check for saved login on page load
        function checkSavedLogin() {
            const saved = localStorage.getItem('ihmc_user');
            if (saved) {
                currentUser = JSON.parse(saved);
                updateUIForLoggedInUser();
            }
        }
        
        // Update UI when user is logged in
        function updateUIForLoggedInUser() {
            const profileBtn = document.getElementById('profile-nav-btn');
            if (currentUser && profileBtn) {
                profileBtn.textContent = currentUser.name.split(' ')[0];
            }
            
            // Show/hide admin button based on admin status
            const adminBtn = document.getElementById('admin-nav-btn');
            if (adminBtn) {
                adminBtn.style.display = isAdmin() ? 'inline-block' : 'none';
            }
            
            // Update unread message badge
            updateMessageBadge();
        }
        
        // Open login modal
        function openLoginModal() {
            document.getElementById('login-modal').classList.add('active');
            document.getElementById('login-ghin').value = '';
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('login-confirm').style.display = 'none';
            document.getElementById('login-lastname-group').style.display = 'none';
            document.getElementById('login-lastname').value = '';
            document.getElementById('login-btn').textContent = 'Find Me';
            document.getElementById('login-btn').onclick = handleLogin;
        }
        
        // Close login modal
        function closeLoginModal() {
            document.getElementById('login-modal').classList.remove('active');
        }
        
        // Handle login
        function handleLogin() {
            const last4Input = document.getElementById('login-ghin').value.trim();
            const errorDiv = document.getElementById('login-error');
            const confirmDiv = document.getElementById('login-confirm');
            const lastnameGroup = document.getElementById('login-lastname-group');
            
            if (!last4Input || last4Input.length !== 4) {
                errorDiv.textContent = 'Please enter the last 4 digits of your GHIN';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Search for members whose GHIN ends with these 4 digits
            const matches = memberDirectory.filter(m => m.ghin && m.ghin.slice(-4) === last4Input);
            
            if (matches.length === 0) {
                // No matches - offer guest registration
                errorDiv.innerHTML = 'No member found with those digits.<br><a href="#" onclick="showNonMemberRegistration(\'' + last4Input + '\')" style="color: var(--gold);">Register as a guest?</a>';
                errorDiv.style.display = 'block';
                confirmDiv.style.display = 'none';
                lastnameGroup.style.display = 'none';
            } else if (matches.length === 1) {
                // Unique match - show confirmation
                errorDiv.style.display = 'none';
                lastnameGroup.style.display = 'none';
                confirmDiv.style.display = 'block';
                document.getElementById('login-confirm-name').textContent = matches[0].name;
                document.getElementById('login-btn').textContent = 'Yes, Sign In';
                document.getElementById('login-btn').onclick = () => confirmLogin(matches[0]);
            } else {
                // Multiple matches - ask for last name
                errorDiv.style.display = 'none';
                confirmDiv.style.display = 'none';
                lastnameGroup.style.display = 'block';
                document.getElementById('login-btn').textContent = 'Find Me';
                document.getElementById('login-btn').onclick = () => handleLoginWithLastName(matches);
            }
        }
        
        // Handle login with last name for duplicates
        function handleLoginWithLastName(matches) {
            const lastname = document.getElementById('login-lastname').value.trim().toLowerCase();
            const errorDiv = document.getElementById('login-error');
            const confirmDiv = document.getElementById('login-confirm');
            
            if (!lastname) {
                errorDiv.textContent = 'Please enter your last name';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Find member by last name
            const member = matches.find(m => {
                const memberLastName = m.name.split(' ').pop().toLowerCase();
                return memberLastName === lastname || memberLastName.startsWith(lastname);
            });
            
            if (member) {
                errorDiv.style.display = 'none';
                confirmDiv.style.display = 'block';
                document.getElementById('login-confirm-name').textContent = member.name;
                document.getElementById('login-btn').textContent = 'Yes, Sign In';
                document.getElementById('login-btn').onclick = () => confirmLogin(member);
            } else {
                errorDiv.textContent = 'No match found. Please check your last name.';
                errorDiv.style.display = 'block';
            }
        }
        
        // Confirm login for existing member
        function confirmLogin(member) {
            currentUser = member;
            localStorage.setItem('ihmc_user', JSON.stringify(member));
            closeLoginModal();
            updateUIForLoggedInUser();
            renderProfile();
            showToast(`Welcome, ${member.name.split(' ')[0]}!`, 'success');
            
            // Load messages and notifications for logged in user
            loadMessages();
            loadNotifications();
            
            // Switch to profile view
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById('profile-nav-btn').classList.add('active');
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById('profile-view').style.display = 'block';
        }
        
        // Show non-member registration form
        function showNonMemberRegistration(last4) {
            const modalBody = document.querySelector('#login-modal .modal-body');
            modalBody.innerHTML = `
                <div class="form-section">
                    <h4>Guest Registration</h4>
                    <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem;">
                        You're not in our roster. Enter your info to register as a guest.
                    </p>
                    <div class="form-group">
                        <label>Full GHIN Number</label>
                        <input type="text" id="guest-ghin" placeholder="Enter your full GHIN #" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label>Your Name</label>
                        <input type="text" id="guest-name" placeholder="First Last" autocomplete="off">
                    </div>
                    <div id="guest-error" style="color: var(--error); font-size: 0.85rem; margin-top: 0.5rem; display: none;"></div>
                </div>
            `;
            document.getElementById('login-btn').textContent = 'Register as Guest';
            document.getElementById('login-btn').onclick = registerGuest;
        }
        
        // Register as guest (non-roster)
        async function registerGuest() {
            const ghin = document.getElementById('guest-ghin').value.trim();
            const name = document.getElementById('guest-name').value.trim();
            const errorDiv = document.getElementById('guest-error');
            
            if (!name) {
                errorDiv.textContent = 'Please enter your name';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Create guest user object
            const guestUser = {
                name: name,
                ghin: ghin,
                email: '',
                subscription: 'Guest',
                status: 'Guest',
                paymentStatus: '',
                handicap: 0,
                isGuest: true
            };
            
            // Save to Firebase as guest
            try {
                const docRef = await db.collection('members').add(guestUser);
                guestUser.id = docRef.id;
                memberDirectory.push(guestUser);
            } catch (error) {
                console.error('Error saving guest:', error);
            }
            
            // Log them in
            currentUser = guestUser;
            localStorage.setItem('ihmc_user', JSON.stringify(guestUser));
            closeLoginModal();
            
            // Reset modal for next time
            resetLoginModal();
            
            updateUIForLoggedInUser();
            renderProfile();
            showToast(`Welcome, ${name}!`, 'success');
            
            // Switch to profile view
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById('profile-nav-btn').classList.add('active');
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById('profile-view').style.display = 'block';
        }
        
        // Reset login modal to default state
        function resetLoginModal() {
            const modalBody = document.querySelector('#login-modal .modal-body');
            modalBody.innerHTML = `
                <div class="form-section">
                    <div class="form-group">
                        <label>GHIN Number</label>
                        <input type="text" id="login-ghin" placeholder="Enter your GHIN #" autocomplete="off">
                    </div>
                    <div id="login-error" style="color: var(--error); font-size: 0.85rem; margin-top: 0.5rem; display: none;"></div>
                    <div id="login-confirm" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--cream); border-radius: var(--radius-md);">
                        <p style="margin-bottom: 0.5rem;">Is this you?</p>
                        <p style="font-size: 1.25rem; font-weight: 600; color: var(--forest);" id="login-confirm-name"></p>
                    </div>
                </div>
            `;
            document.getElementById('login-btn').textContent = 'Find Me';
            document.getElementById('login-btn').onclick = handleLogin;
        }
        
        // Log out
        function logout() {
            currentUser = null;
            localStorage.removeItem('ihmc_user');
            document.getElementById('profile-nav-btn').innerHTML = 'Profile';
            renderProfile();
            showToast('Signed out', 'success');
        }
        
        // Render profile page
        function renderProfile() {
            const container = document.getElementById('profile-content');
            
            if (!currentUser) {
                // Not logged in - show login prompt
                container.innerHTML = `
                    <div class="login-prompt">
                        <h3>Sign In to View Your Profile</h3>
                        <p>Enter your GHIN number to access your profile, view registration history, and more.</p>
                        <button class="btn btn-primary" onclick="openLoginModal()">Sign In with GHIN</button>
                    </div>
                `;
                return;
            }
            
            // Logged in - show profile
            const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
            const isGuest = currentUser.isGuest || currentUser.subscription === 'Guest';
            const hasPhoto = currentUser.photoURL && currentUser.photoURL.length > 0;
            
            container.innerHTML = `
                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-avatar-wrapper">
                            ${hasPhoto 
                                ? `<img src="${currentUser.photoURL}" alt="${currentUser.name}" class="profile-avatar-img">`
                                : `<div class="profile-avatar">${initials}</div>`
                            }
                            <label class="profile-photo-edit" title="Change photo">
                                <input type="file" accept="image/*" onchange="uploadProfilePhoto(this)" style="display: none;">
                                
                            </label>
                        </div>
                        <h2>${currentUser.name}</h2>
                        <p>GHIN: ${currentUser.ghin}</p>
                    </div>
                    <div class="profile-details">
                        <div class="profile-row">
                            <span class="profile-label">Membership</span>
                            <span class="profile-value">${currentUser.subscription || 'Guest'}</span>
                        </div>
                        <div class="profile-row">
                            <span class="profile-label">Status</span>
                            <span class="status-badge ${currentUser.status === 'Active' ? 'active' : ''}">${currentUser.status || 'Guest'}</span>
                        </div>
                        ${!isGuest ? `
                        <div class="profile-row">
                            <span class="profile-label">Payment</span>
                            <span class="status-badge ${currentUser.paymentStatus === 'Paid' ? 'paid' : ''}">${currentUser.paymentStatus || 'N/A'}</span>
                        </div>
                        <div class="profile-row">
                            <span class="profile-label">Email</span>
                            <span class="profile-value">${currentUser.email || 'Not on file'}</span>
                        </div>
                        <div class="profile-row">
                            <span class="profile-label">Phone</span>
                            <span class="profile-value">${currentUser.phone || 'Not on file'}</span>
                        </div>
                        <div class="profile-row">
                            <span class="profile-label">Membership Expires</span>
                            <span class="profile-value">${currentUser.subscriptionEnd || 'N/A'}</span>
                        </div>
                        ` : ''}
                        <div class="profile-row">
                            <span class="profile-label">Handicap</span>
                            <span class="profile-value">${currentUser.handicap || 'Not set'}</span>
                        </div>
                    </div>
                    
                    <!-- Quick Links Section -->
                    <div class="profile-quick-links">
                        <a href="https://www.ghin.com/login" target="_blank" class="profile-quick-link">
                            <span></span> Handicap Lookup
                        </a>
                        <button class="profile-quick-link" onclick="openPayDuesModal()">
                            <span></span> Pay Dues
                        </button>
                    </div>
                    
                    <div class="profile-actions">
                        <button class="btn btn-primary" onclick="openEditProfileModal()">Edit Profile</button>
                        <button class="btn btn-outline" onclick="logout()">Sign Out</button>
                    </div>
                </div>
            `;
        }
        
        // Upload profile photo
        async function uploadProfilePhoto(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('Photo must be under 2MB', 'error');
                return;
            }
            
            showToast('Uploading photo...', 'success');
            
            // Convert to base64 for simple storage
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64 = e.target.result;
                
                // Resize image to reduce storage size
                const resized = await resizeImage(base64, 200, 200);
                
                try {
                    // Update in Firebase
                    await db.collection('members').doc(currentUser.id).update({
                        photoURL: resized
                    });
                    
                    // Update local user
                    currentUser.photoURL = resized;
                    localStorage.setItem('ihmc_user', JSON.stringify(currentUser));
                    
                    // Update member directory
                    const idx = memberDirectory.findIndex(m => m.id === currentUser.id);
                    if (idx >= 0) memberDirectory[idx].photoURL = resized;
                    
                    renderProfile();
                    showToast('Photo updated!', 'success');
                } catch (error) {
                    console.error('Error uploading photo:', error);
                    showToast('Error uploading photo', 'error');
                }
            };
            reader.readAsDataURL(file);
        }
        
        // Resize image helper
        function resizeImage(base64, maxWidth, maxHeight) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Calculate new dimensions
                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = base64;
            });
        }
        
        // Open edit profile modal
        function openEditProfileModal() {
            document.getElementById('edit-profile-name').value = currentUser.name || '';
            document.getElementById('edit-profile-email').value = currentUser.email || '';
            document.getElementById('edit-profile-phone').value = currentUser.phone || '';
            document.getElementById('edit-profile-modal').classList.add('active');
        }
        
        // Close edit profile modal
        function closeEditProfileModal() {
            document.getElementById('edit-profile-modal').classList.remove('active');
        }
        
        // Save profile edits
        async function saveProfileEdits() {
            const name = document.getElementById('edit-profile-name').value.trim();
            const email = document.getElementById('edit-profile-email').value.trim();
            const phone = document.getElementById('edit-profile-phone').value.trim();
            
            if (!name) {
                showToast('Name is required', 'error');
                return;
            }
            
            try {
                // Update in Firebase
                await db.collection('members').doc(currentUser.id).update({
                    name: name,
                    email: email,
                    phone: phone
                });
                
                // Update local user
                currentUser.name = name;
                currentUser.email = email;
                currentUser.phone = phone;
                localStorage.setItem('ihmc_user', JSON.stringify(currentUser));
                
                // Update member directory
                const idx = memberDirectory.findIndex(m => m.id === currentUser.id);
                if (idx >= 0) {
                    memberDirectory[idx].name = name;
                    memberDirectory[idx].email = email;
                    memberDirectory[idx].phone = phone;
                }
                
                // Update nav button
                updateUIForLoggedInUser();
                
                closeEditProfileModal();
                renderProfile();
                showToast('Profile updated!', 'success');
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('Error updating profile', 'error');
            }
        }

        // 2026 IHMC Tournament Schedule
        let events = [
            // January
            {
                id: 1,
                name: '2-Man Select Shot',
                type: 'tournament',
                date: '2026-01-11',
                time: '07:20',
                teamSize: 2,
                entryFee: 50,
                format: 'select-shot',
                maxTeams: 52,
                registeredTeams: 0,
                description: 'Must use 6 drives from each player. Gross & Net'
            },
            // February
            {
                id: 2,
                name: "President's Cup Qualifier",
                type: 'tournament',
                date: '2026-02-08',
                time: '07:20',
                teamSize: 1,
                entryFee: 50,
                format: 'stroke',
                maxTeams: 52,
                registeredTeams: 0,
                description: 'Individual stroke play. Blind draw A & B player 4-hole aggregate. Gross & Net.'
            },
            // March
            {
                id: 3,
                name: 'Mod-Pinehurst',
                type: 'tournament',
                date: '2026-03-08',
                time: '07:20',
                teamSize: 2,
                entryFee: 50,
                format: 'pinehurst',
                maxTeams: 52,
                registeredTeams: 0,
                description: 'Each player hits their drive then pick the best drive. Then alternate shot. Must use 6 drives from each player. White Tees gross & net'
            },
            // April
            {
                id: 4,
                name: 'Away Tournament',
                type: 'tournament',
                date: '2026-04-12',
                time: '07:20',
                teamSize: 1,
                entryFee: 50,
                format: 'stroke',
                maxTeams: 52,
                registeredTeams: 0,
                description: 'Individual tournament. Gross & Net. Location TBD'
            },
            // May
            {
                id: 5,
                name: "President's Cup Final",
                type: 'tournament',
                date: '2026-05-17',
                time: '07:20',
                teamSize: 2,
                entryFee: 50,
                format: 'best-ball',
                maxTeams: 52,
                registeredTeams: 0,
                description: '2-Man Best Ball 4-Hole Aggregate. Gross & Net. You do not have to play in the 2-Man Best Ball Tournament to play your match in the Presidents Cup Qualifier.'
            },
            // June - Club Championship (multiple days)
            {
                id: 6,
                name: 'Club Championship',
                type: 'tournament',
                date: '2026-06-06',
                time: '07:20',
                teamSize: 1,
                entryFee: 75,
                format: 'stroke',
                maxTeams: 52,
                registeredTeams: 0,
                description: '2 Saturdays & 2 Sundays (6/6, 6/7, 6/13, 6/14). Gross & Net Prizes'
            },
            {
                id: 7,
                name: 'Sr. Club Championship',
                type: 'tournament',
                date: '2026-06-06',
                time: '07:20',
                teamSize: 1,
                entryFee: 60,
                format: 'stroke',
                maxTeams: 52,
                registeredTeams: 0,
                description: '1st & 2nd, Saturday & Sunday. Gross & Net Prizes'
            },
            {
                id: 8,
                name: 'Net Club Championship',
                type: 'tournament',
                date: '2026-06-06',
                time: '07:20',
                teamSize: 1,
                entryFee: 60,
                format: 'stroke',
                maxTeams: 52,
                registeredTeams: 0,
                description: '8th & 9th Saturday & Sunday. All Net'
            },
            // July
            {
                id: 9,
                name: '2-Man Criss Cross',
                type: 'tournament',
                date: '2026-07-12',
                time: '07:20',
                teamSize: 2,
                entryFee: 50,
                format: 'criss-cross',
                maxTeams: 52,
                registeredTeams: 0,
                description: 'Full Avg. HC Partners HC differential. Gross & Net'
            },
            // August
            {
                id: 10,
                name: 'Yellow Ball Tournament',
                type: 'tournament',
                date: '2026-08-09',
                time: '07:20',
                teamSize: 4,
                entryFee: 50,
                format: 'yellow-ball',
                maxTeams: 52,
                registeredTeams: 0,
                description: 'Pick Your Own 4-Man Teams. Each team member hits the yellow ball on a hole. Then every 4 holes the rotation starts over. (1 yellow ball per team). Gross & Net'
            },
            // September
            {
                id: 11,
                name: 'Member/Member',
                type: 'tournament',
                date: '2026-09-13',
                time: '07:20',
                teamSize: 2,
                entryFee: 50,
                format: 'aggregate',
                maxTeams: 52,
                registeredTeams: 0,
                description: '18 Hole Aggregate. Gross & Net'
            },
            // October
            {
                id: 12,
                name: 'Hole in One',
                type: 'tournament',
                date: '2026-10-11',
                time: '07:20',
                teamSize: 1,
                entryFee: 50,
                format: 'stroke',
                maxTeams: 52,
                registeredTeams: 0,
                description: 'Individual Net'
            },
            {
                id: 13,
                name: '2-Man Best Ball',
                type: 'tournament',
                date: '2026-10-11',
                time: '07:20',
                teamSize: 2,
                entryFee: 50,
                format: 'best-ball',
                maxTeams: 52,
                registeredTeams: 0,
                description: 'Gross & Net. You do not have to play in the 2-Man Best Ball Tournament to play in the Hole in One Tournament.'
            },
            // November
            {
                id: 14,
                name: "Player's Tournament",
                type: 'tournament',
                date: '2026-11-08',
                time: '07:20',
                teamSize: 2,
                entryFee: 50,
                format: 'best-ball',
                maxTeams: 52,
                registeredTeams: 0,
                description: '2-man best ball no aggregate holes. Must have played in 6 tournaments the past 12 months. Gross & Net'
            },
            {
                id: 15,
                name: 'Turkey Shoot',
                type: 'tournament',
                date: '2026-11-22',
                time: '07:20',
                teamSize: 4,
                entryFee: 50,
                format: 'best-ball',
                maxTeams: 52,
                registeredTeams: 0,
                description: '4-Man Best 2 Balls. Gross & Net'
            },
            // December
            {
                id: 16,
                name: '3-Man Team Blue, White, Red Tees',
                type: 'tournament',
                date: '2026-12-13',
                time: '07:20',
                teamSize: 3,
                entryFee: 50,
                format: '2-3-1-best-ball',
                maxTeams: 52,
                registeredTeams: 0,
                description: 'Pick your own 3-man team. Will only get 80% of your hdcp. 2-3-1 Best Ball. Gross & Net'
            },
            // SUNDAY SCRAMBLES - All non-tournament Sundays
            // January (tournament on 11th)
            { id: 100, name: 'Sunday Scramble', type: 'scramble', date: '2026-01-04', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 101, name: 'Sunday Scramble', type: 'scramble', date: '2026-01-18', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 102, name: 'Sunday Scramble', type: 'scramble', date: '2026-01-25', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            // February (tournament on 8th)
            { id: 103, name: 'Sunday Scramble', type: 'scramble', date: '2026-02-01', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 104, name: 'Sunday Scramble', type: 'scramble', date: '2026-02-15', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 105, name: 'Sunday Scramble', type: 'scramble', date: '2026-02-22', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            // March (tournament on 8th)
            { id: 106, name: 'Sunday Scramble', type: 'scramble', date: '2026-03-01', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 107, name: 'Sunday Scramble', type: 'scramble', date: '2026-03-15', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 108, name: 'Sunday Scramble', type: 'scramble', date: '2026-03-22', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 109, name: 'Sunday Scramble', type: 'scramble', date: '2026-03-29', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            // April (tournament on 12th)
            { id: 110, name: 'Sunday Scramble', type: 'scramble', date: '2026-04-05', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 111, name: 'Sunday Scramble', type: 'scramble', date: '2026-04-19', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 112, name: 'Sunday Scramble', type: 'scramble', date: '2026-04-26', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            // May (tournament on 17th)
            { id: 113, name: 'Sunday Scramble', type: 'scramble', date: '2026-05-03', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 114, name: 'Sunday Scramble', type: 'scramble', date: '2026-05-10', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 115, name: 'Sunday Scramble', type: 'scramble', date: '2026-05-24', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 116, name: 'Sunday Scramble', type: 'scramble', date: '2026-05-31', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            // June (Club Championship weekends: 6/6, 6/7, 6/13, 6/14)
            { id: 117, name: 'Sunday Scramble', type: 'scramble', date: '2026-06-21', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 118, name: 'Sunday Scramble', type: 'scramble', date: '2026-06-28', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            // July (tournament on 12th)
            { id: 119, name: 'Sunday Scramble', type: 'scramble', date: '2026-07-05', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 120, name: 'Sunday Scramble', type: 'scramble', date: '2026-07-19', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 121, name: 'Sunday Scramble', type: 'scramble', date: '2026-07-26', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            // August (tournament on 9th)
            { id: 122, name: 'Sunday Scramble', type: 'scramble', date: '2026-08-02', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 123, name: 'Sunday Scramble', type: 'scramble', date: '2026-08-16', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 124, name: 'Sunday Scramble', type: 'scramble', date: '2026-08-23', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 125, name: 'Sunday Scramble', type: 'scramble', date: '2026-08-30', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            // September (tournament on 13th)
            { id: 126, name: 'Sunday Scramble', type: 'scramble', date: '2026-09-06', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 127, name: 'Sunday Scramble', type: 'scramble', date: '2026-09-20', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 128, name: 'Sunday Scramble', type: 'scramble', date: '2026-09-27', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            // October (tournament on 11th)
            { id: 129, name: 'Sunday Scramble', type: 'scramble', date: '2026-10-04', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 130, name: 'Sunday Scramble', type: 'scramble', date: '2026-10-18', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 131, name: 'Sunday Scramble', type: 'scramble', date: '2026-10-25', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            // November (tournaments on 8th and 22nd)
            { id: 132, name: 'Sunday Scramble', type: 'scramble', date: '2026-11-01', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 133, name: 'Sunday Scramble', type: 'scramble', date: '2026-11-15', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 134, name: 'Sunday Scramble', type: 'scramble', date: '2026-11-29', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            // December (tournament on 13th)
            { id: 135, name: 'Sunday Scramble', type: 'scramble', date: '2026-12-06', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 136, name: 'Sunday Scramble', type: 'scramble', date: '2026-12-20', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' },
            { id: 137, name: 'Sunday Scramble', type: 'scramble', date: '2026-12-27', time: '07:20', teamSize: 4, entryFee: 30, format: 'stroke', maxTeams: 30, registeredTeams: 0, description: 'Weekly stroke play - all skill levels welcome' }
        ];

        // My registrations data
        let myRegistrations = [];

        // Current state
        let currentEventId = null;
        let currentTeamMembers = [];
        let currentFilter = 'all';

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadFromFirebase();
            checkSavedLogin();
            await loadMessages();
            await loadNotifications();
            renderEvents();
            setupNavigation();
            setupFilters();
            
            // Refresh notifications periodically (every 60 seconds)
            setInterval(() => {
                if (currentUser) {
                    loadNotifications();
                    loadMessages();
                }
            }, 60000);
        });

        // Load data from Firebase
        async function loadFromFirebase() {
            try {
                // Load events
                const eventsSnapshot = await db.collection('events').get();
                if (!eventsSnapshot.empty) {
                    events = eventsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                }
                
                // Load members
                const membersSnapshot = await db.collection('members').get();
                if (!membersSnapshot.empty) {
                    memberDirectory.length = 0; // Clear existing
                    membersSnapshot.docs.forEach(doc => {
                        memberDirectory.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                }
                
                // Load past winners
                const winnersSnapshot = await db.collection('winners').get();
                if (!winnersSnapshot.empty) {
                    pastWinners.length = 0; // Clear existing
                    winnersSnapshot.docs.forEach(doc => {
                        pastWinners.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                }
                
                console.log('Firebase data loaded successfully');
            } catch (error) {
                console.log('Using default data (Firebase not loaded):', error);
            }
        }

        // Navigation
        function setupNavigation() {
            document.querySelectorAll('nav button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    
                    // Update active button
                    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Show correct view
                    document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
                    document.getElementById(`${view}-view`).style.display = 'block';
                    
                    // Render content
                    if (view === 'my-registrations') {
                        renderMyRegistrations();
                    } else if (view === 'past-winners') {
                        renderPastWinners();
                    } else if (view === 'profile') {
                        renderProfile();
                    } else if (view === 'messages') {
                        renderMessages();
                    }
                });
            });
        }

        // Filters
        function setupFilters() {
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const parent = tab.parentElement;
                    parent.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const filter = tab.dataset.filter;
                    if (filter === 'all' || filter === 'tournament' || filter === 'scramble') {
                        currentFilter = filter;
                        renderEvents();
                    } else {
                        // Past winners filter
                        currentWinnersFilter = filter;
                        renderPastWinners();
                    }
                });
            });
        }

        // Past Winners Data
        let currentWinnersFilter = 'all-winners';
        let pastWinners = [
            // Add your past winners here - this is sample data
            { id: 1, event: 'Club Championship', date: '2025-06-14', year: '2025', grossWinner: 'Mike Johnson', grossScore: 72, netWinner: 'Tom Anderson', netScore: 68 },
            { id: 2, event: 'Turkey Shoot', date: '2025-11-22', year: '2025', grossWinner: 'Steve Williams', grossScore: 145, netWinner: 'Bob Richardson', netScore: 132 },
            { id: 3, event: "President's Cup", date: '2025-05-17', year: '2025', grossWinner: 'Dave Martinez & Chris Thompson', grossScore: 64, netWinner: 'Jim Patterson & Gary Nelson', netScore: 59 },
        ];

        // Render Past Winners
        function renderPastWinners() {
            const container = document.getElementById('past-winners-list');
            
            const filteredWinners = pastWinners.filter(w => 
                currentWinnersFilter === 'all-winners' || w.year === currentWinnersFilter
            ).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredWinners.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h4>No results yet</h4>
                        <p>Check back after tournaments are completed!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredWinners.map(winner => `
                <div class="winner-card">
                    <div class="winner-header">
                        <div class="winner-event">
                            <h4>${winner.event}</h4>
                            <p>${formatDate(winner.date)}</p>
                        </div>
                        <div class="winner-trophy"></div>
                    </div>
                    <div class="winner-results">
                        <div class="winner-category">
                            <span class="category-label">Gross Winner</span>
                            <span class="winner-name">${winner.grossWinner}</span>
                            <span class="winner-score">${winner.grossScore}</span>
                        </div>
                        <div class="winner-category">
                            <span class="category-label">Net Winner</span>
                            <span class="winner-name">${winner.netWinner}</span>
                            <span class="winner-score">${winner.netScore}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render Events
        function renderEvents() {
            const grid = document.getElementById('events-grid');
            const filteredEvents = events.filter(e => 
                currentFilter === 'all' || e.type === currentFilter
            ).sort((a, b) => new Date(a.date) - new Date(b.date));

            if (filteredEvents.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h4>No events found</h4>
                        <p>Check back soon for upcoming events!</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredEvents.map(event => {
                // Parse date parts to avoid timezone issues
                const [year, month, day] = event.date.split('-').map(Number);
                const date = new Date(year, month - 1, day); // month is 0-indexed
                const spotsRemaining = event.maxTeams - event.registeredTeams;
                const isLow = spotsRemaining <= 3;
                const isFull = spotsRemaining <= 0;

                return `
                    <div class="event-card">
                        <div class="event-card-header ${event.type === 'scramble' ? 'scramble' : ''}">
                            <div class="event-date">
                                <div class="date-box">
                                    <div class="month">${date.toLocaleDateString('en-US', { month: 'short' })}</div>
                                    <div class="day">${date.getDate()}</div>
                                    <div class="weekday">${date.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                                </div>
                                <div class="event-title">
                                    <h4>${event.name}</h4>
                                    <p>${event.description || formatName(event.format) + ' Format'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="event-card-body">
                            <div class="event-details">
                                <div class="detail-item">
                                    <div class="detail-icon"></div>
                                    <div class="detail-text">
                                        <span>Tee Time</span>
                                        ${formatTime(event.time)}
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-icon"></div>
                                    <div class="detail-text">
                                        <span>Team Size</span>
                                        ${event.teamSize}-Man Teams
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-icon"></div>
                                    <div class="detail-text">
                                        <span>Format</span>
                                        ${formatName(event.format)}
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-icon"></div>
                                    <div class="detail-text">
                                        <span>Entry Fee</span>
                                        $${event.entryFee}/player
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="event-card-footer">
                            <div class="spots-remaining ${isLow ? 'low' : ''}">
                                ${isFull ? 'Event Full' : `<strong>${spotsRemaining}</strong> spots remaining`}
                            </div>
                            <button class="btn btn-primary" onclick="openRegistration('${event.id}')" ${isFull ? 'disabled' : ''}>
                                ${isFull ? 'Waitlist' : 'Register'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open Registration Modal
        function openRegistration(eventId) {
            currentEventId = eventId;
            currentTeamMembers = [];
            currentPlayer1 = null;
            
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            // Reset modal
            document.getElementById('registration-form-container').style.display = 'block';
            document.getElementById('registration-success-container').style.display = 'none';
            document.getElementById('modal-footer').style.display = 'flex';
            
            // Set header
            document.getElementById('modal-event-name').textContent = event.name;
            const eventTypeLabel = event.teamSize === 1 ? 'Individual' : `${event.teamSize}-Man`;
            document.getElementById('modal-event-date').textContent = 
                `${formatDate(event.date)} at ${formatTime(event.time)}  ${eventTypeLabel} ${formatName(event.format)}`;
            
            // Clear form
            document.getElementById('team-members-container').innerHTML = '';
            document.getElementById('tee-time-preference').value = 'no-preference';
            document.getElementById('registration-notes').value = '';
            
            // Auto-fill Player 1 if logged in
            if (currentUser) {
                document.getElementById('player1-name').value = currentUser.name;
                currentPlayer1 = { 
                    name: currentUser.name, 
                    memberId: currentUser.id, 
                    handicap: currentUser.handicap || 0 
                };
            } else {
                document.getElementById('player1-name').value = '';
            }
            
            // Set title and description based on event type
            const titleEl = document.getElementById('teammates-title');
            const descEl = document.getElementById('teammates-description');
            
            if (event.teamSize === 1) {
                titleEl.textContent = 'Complete Your Foursome (Optional)';
                descEl.textContent = 'Select up to 3 others to play with, or leave blank for TD to assign';
            } else if (event.teamSize === 2) {
                titleEl.textContent = 'Your Partner & Foursome';
                descEl.textContent = 'Select your partner (Player 2), then optionally add another 2-man team to play with';
            } else if (event.teamSize === 3) {
                titleEl.textContent = 'Your Teammates';
                descEl.textContent = 'Select your 2 teammates, or leave blank for TD to assign';
            } else if (event.teamSize === 4) {
                titleEl.textContent = 'Your Team';
                descEl.textContent = 'Select your 3 teammates, or leave blank for TD to assign';
            }
            
            // Update add button
            updateAddMemberButton(event.teamSize);
            
            // Update total
            updateTotal(event);
            
            // Show modal
            document.getElementById('registration-modal').classList.add('active');
        }

        // Close Modal
        function closeModal() {
            document.getElementById('registration-modal').classList.remove('active');
            currentEventId = null;
            currentTeamMembers = [];
        }

        // Add Team Member
        function addTeamMember() {
            const event = events.find(e => e.id === currentEventId);
            if (!event) return;
            
            // Max additional players based on event type
            // Individual: 3 (to complete foursome)
            // 2-man: 3 (partner + other 2-man team)
            // 3-man: 2 (teammates only, no 4th)
            // 4-man: 3 (teammates)
            const maxSlots = event.teamSize === 3 ? 2 : 3;
            if (currentTeamMembers.length >= maxSlots) return;
            
            const memberIndex = currentTeamMembers.length;
            currentTeamMembers.push({ name: '', memberId: null });
            
            // Determine player label based on event type and position
            let playerLabel = '';
            if (event.teamSize === 1) {
                // Individual event - all are foursome players
                playerLabel = `Foursome Player ${memberIndex + 1}`;
            } else if (event.teamSize === 2) {
                if (memberIndex === 0) {
                    playerLabel = 'Your Partner';
                } else {
                    playerLabel = `Other Team Player ${memberIndex}`;
                }
            } else if (event.teamSize === 3) {
                playerLabel = `Teammate ${memberIndex + 1}`;
            } else if (event.teamSize === 4) {
                playerLabel = `Teammate ${memberIndex + 1}`;
            }
            
            const container = document.getElementById('team-members-container');
            const memberDiv = document.createElement('div');
            memberDiv.className = 'team-member-row';
            memberDiv.id = `member-row-${memberIndex}`;
            memberDiv.innerHTML = `
                <div>
                    <div class="member-number">${memberIndex + 2}</div>
                    <div class="form-group">
                        <label>${playerLabel}</label>
                        <div class="member-select-wrapper">
                            <div class="member-search">
                                <input type="text" 
                                    id="member-input-${memberIndex}" 
                                    placeholder="Search members..."
                                    oninput="filterMembers(${memberIndex})"
                                    onfocus="showMemberDropdown(${memberIndex})"
                                    autocomplete="off">
                            </div>
                            <div class="member-dropdown" id="member-dropdown-${memberIndex}">
                                ${memberDirectory.map(m => `
                                    <div class="member-option" onclick="selectMember(${memberIndex}, '${m.id}', '${m.name}', ${m.handicap})">
                                        <div class="name">${m.name}</div>
                                        <div class="handicap">Handicap: ${m.handicap}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" class="remove-member" onclick="removeTeamMember(${memberIndex})"></button>
            `;
            container.appendChild(memberDiv);
            
            // Update button
            updateAddMemberButton(event.teamSize);
            updateTotal(event);
            
            // Add click outside listener
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById(`member-dropdown-${memberIndex}`);
                const input = document.getElementById(`member-input-${memberIndex}`);
                if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
                    dropdown.classList.remove('active');
                }
            });
        }

        // Show Member Dropdown
        function showMemberDropdown(index) {
            document.getElementById(`member-dropdown-${index}`).classList.add('active');
        }

        // Player 1 dropdown functions
        let currentPlayer1 = null;
        
        function showPlayer1Dropdown() {
            const dropdown = document.getElementById('player1-dropdown');
            dropdown.innerHTML = memberDirectory.map(m => `
                <div class="member-option" onclick="selectPlayer1('${m.id}', '${m.name}', ${m.handicap})">
                    <div class="name">${m.name}</div>
                    <div class="handicap">Handicap: ${m.handicap}</div>
                </div>
            `).join('');
            dropdown.classList.add('active');
        }
        
        function filterPlayer1() {
            const input = document.getElementById('player1-name');
            const dropdown = document.getElementById('player1-dropdown');
            const filter = input.value.toLowerCase();
            
            dropdown.innerHTML = memberDirectory
                .filter(m => m.name.toLowerCase().includes(filter))
                .map(m => `
                    <div class="member-option" onclick="selectPlayer1('${m.id}', '${m.name}', ${m.handicap})">
                        <div class="name">${m.name}</div>
                        <div class="handicap">Handicap: ${m.handicap}</div>
                    </div>
                `).join('');
            
            dropdown.classList.add('active');
        }
        
        function selectPlayer1(memberId, name, handicap) {
            document.getElementById('player1-name').value = name;
            document.getElementById('player1-dropdown').classList.remove('active');
            currentPlayer1 = { name, memberId, handicap };
        }
        
        // Close Player 1 dropdown on click outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('player1-dropdown');
            const input = document.getElementById('player1-name');
            if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
                dropdown.classList.remove('active');
            }
        });

        // Filter Members
        function filterMembers(index) {
            const input = document.getElementById(`member-input-${index}`);
            const dropdown = document.getElementById(`member-dropdown-${index}`);
            const filter = input.value.toLowerCase();
            
            dropdown.innerHTML = memberDirectory
                .filter(m => m.name.toLowerCase().includes(filter))
                .map(m => `
                    <div class="member-option" onclick="selectMember(${index}, '${m.id}', '${escapeHtml(m.name)}', ${m.handicap})">
                        <div class="name">${escapeHtml(m.name)}</div>
                        <div class="handicap">Handicap: ${m.handicap}</div>
                    </div>
                `).join('');
            
            dropdown.classList.add('active');
        }

        // Select Member
        function selectMember(index, memberId, name, handicap) {
            document.getElementById(`member-input-${index}`).value = name;
            document.getElementById(`member-dropdown-${index}`).classList.remove('active');
            currentTeamMembers[index] = { name, memberId, handicap };
        }

        // Remove Team Member
        function removeTeamMember(index) {
            const event = events.find(e => e.id === currentEventId);
            document.getElementById(`member-row-${index}`).remove();
            currentTeamMembers.splice(index, 1);
            
            // Re-render remaining members with correct indices
            const container = document.getElementById('team-members-container');
            container.innerHTML = '';
            const tempMembers = [...currentTeamMembers];
            currentTeamMembers = [];
            
            tempMembers.forEach((member, i) => {
                currentTeamMembers.push(member);
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member-row';
                memberDiv.id = `member-row-${i}`;
                memberDiv.innerHTML = `
                    <div>
                        <div class="member-number">${i + 2}</div>
                        <div class="form-group">
                            <label>Team Member Name</label>
                            <div class="member-select-wrapper">
                                <div class="member-search">
                                    <input type="text" 
                                        id="member-input-${i}" 
                                        value="${member.name}"
                                        placeholder="Search members..."
                                        oninput="filterMembers(${i})"
                                        onfocus="showMemberDropdown(${i})"
                                        autocomplete="off">
                                </div>
                                <div class="member-dropdown" id="member-dropdown-${i}">
                                    ${memberDirectory.map(m => `
                                        <div class="member-option" onclick="selectMember(${i}, '${m.id}', '${escapeHtml(m.name)}', ${m.handicap})">
                                            <div class="name">${escapeHtml(m.name)}</div>
                                            <div class="handicap">Handicap: ${m.handicap}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="remove-member" onclick="removeTeamMember(${i})"></button>
                `;
                container.appendChild(memberDiv);
            });
            
            updateAddMemberButton(event.teamSize);
            updateTotal(event);
        }

        // Update Add Member Button
        function updateAddMemberButton(teamSize) {
            const btn = document.getElementById('add-member-btn');
            const event = events.find(e => e.id === currentEventId);
            // Max slots: 3 for most events, 2 for 3-man (no 4th player)
            const maxSlots = teamSize === 3 ? 2 : 3;
            const remaining = maxSlots - currentTeamMembers.length;
            
            if (remaining <= 0) {
                btn.disabled = true;
                if (teamSize === 3) {
                    btn.textContent = 'Team Complete (3 players)';
                } else if (teamSize === 2) {
                    btn.textContent = 'Foursome Complete';
                } else {
                    btn.textContent = 'Foursome Complete';
                }
            } else {
                btn.disabled = false;
                // Context-aware button text
                if (teamSize === 1) {
                    btn.textContent = `+ Add Foursome Player (${remaining} spot${remaining > 1 ? 's' : ''} left)`;
                } else if (teamSize === 2) {
                    if (currentTeamMembers.length === 0) {
                        btn.textContent = '+ Add Your Partner';
                    } else {
                        btn.textContent = `+ Add Other Team Player (${remaining} spot${remaining > 1 ? 's' : ''} left)`;
                    }
                } else if (teamSize === 3) {
                    btn.textContent = `+ Add Teammate (${remaining} spot${remaining > 1 ? 's' : ''} left)`;
                } else {
                    btn.textContent = `+ Add Teammate (${remaining} spot${remaining > 1 ? 's' : ''} left)`;
                }
            }
        }

        // Update Total
        function updateTotal(event) {
            // Individual/Scramble: only registering player pays
            // 2-man: player + partner (first teammate) pay
            // 3-man: player + 2 teammates pay
            // 4-man: player + 3 teammates pay
            let playerCount = 1;
            
            if (event.teamSize === 1) {
                // Individual - only the person registering pays
                playerCount = 1;
            } else if (event.teamSize === 2) {
                // 2-man - player + partner pay (partner is first in currentTeamMembers)
                const hasPartner = currentTeamMembers.length > 0 && currentTeamMembers[0].name;
                playerCount = hasPartner ? 2 : 1;
            } else if (event.teamSize === 3) {
                // 3-man - count player + filled teammates
                const filledTeammates = currentTeamMembers.filter(m => m.name).length;
                playerCount = 1 + Math.min(filledTeammates, 2);
            } else if (event.teamSize === 4) {
                // 4-man - count player + filled teammates
                const filledTeammates = currentTeamMembers.filter(m => m.name).length;
                playerCount = 1 + Math.min(filledTeammates, 3);
            }
            
            const total = playerCount * event.entryFee;
            document.getElementById('registration-total').textContent = `$${total}`;
        }

        // Google Sheets API URL
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbx9dxCWG8BvQ5lnofM-fELqvD7qPSeplBbgTP-9J6h0CnHke33BmYwXI0UFhRR0SIzz/exec';

        // Submit Registration
        async function submitRegistration() {
            const event = events.find(e => e.id === currentEventId);
            if (!event) return;
            
            const player1Input = document.getElementById('player1-name').value.trim();
            const teeTimePref = document.getElementById('tee-time-preference').value;
            const notes = document.getElementById('registration-notes').value.trim();
            
            // Validation - must select from member directory
            if (!player1Input) {
                showToast('Please select your name from the member list', 'error');
                return;
            }
            
            // Verify player1 is in member directory
            const player1Match = memberDirectory.find(m => m.name.toLowerCase() === player1Input.toLowerCase());
            if (!player1Match) {
                showToast('Please select a valid member from the list', 'error');
                return;
            }
            
            const player1Name = player1Match.name; // Use exact name from directory
            
            // Update team member names from inputs
            for (let i = 0; i < currentTeamMembers.length; i++) {
                const input = document.getElementById(`member-input-${i}`);
                if (input && input.value.trim()) {
                    currentTeamMembers[i].name = input.value.trim();
                }
            }
            
            // Get filled team members
            const filledMembers = currentTeamMembers.filter(m => m.name);
            
            // Disable submit button while processing
            const submitBtn = document.getElementById('submit-registration');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span> Registering...';
            
            // Calculate total based on event type
            let total = event.entryFee; // Player 1 always pays
            if (event.teamSize >= 2) {
                // For team events, each filled teammate also pays
                const payingTeammates = Math.min(filledMembers.length, event.teamSize - 1);
                total = (1 + payingTeammates) * event.entryFee;
            }
            
            // Format tee time preference for Google Sheets (shorter labels)
            const teeTimePrefForSheets = {
                'no-preference': '',
                'first-off': 'First Off',
                'earlier': 'Earlier',
                'later': 'Later',
                'last-off': 'Last Off'
            };
            
            // Create registration data for Google Sheets (simplified: Player 1-4)
            const registrationData = {
                event: event.name,
                eventDate: event.date,
                player1: player1Name,
                player2: filledMembers[0]?.name || '',
                player3: filledMembers[1]?.name || '',
                player4: filledMembers[2]?.name || '',
                entryFee: event.entryFee,
                total: total,
                teeTimePref: teeTimePrefForSheets[teeTimePref] || '',
                notes: notes
            };
            
            try {
                // Send to Google Sheets
                await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(registrationData)
                });
                
                // Create local registration record
                const registration = {
                    id: Date.now(),
                    eventId: event.id,
                    eventName: event.name,
                    eventDate: event.date,
                    players: [player1Name, ...filledMembers.map(m => m.name)],
                    total: total,
                    teeTimePref: teeTimePref,
                    notes: notes,
                    registeredAt: new Date().toISOString()
                };
                
                myRegistrations.push(registration);
                
                // Update event
                event.registeredTeams++;
                
                // *** NOTIFICATIONS ***
                // Notify other players they were registered
                for (const member of filledMembers) {
                    if (member.memberId && member.memberId !== currentUser?.id) {
                        createNotification(
                            member.memberId,
                            'registration',
                            'You\'ve been registered!',
                            `${player1Name} registered you for ${event.name} on ${formatDate(event.date)}`,
                            event.id
                        );
                    }
                }
                
                // Check if event is within 24 hours - notify admin
                const eventDateTime = new Date(event.date + 'T' + event.time);
                const now = new Date();
                const hoursUntilEvent = (eventDateTime - now) / (1000 * 60 * 60);
                
                if (hoursUntilEvent <= 24 && hoursUntilEvent > 0) {
                    // Create admin notification for late registration
                    createNotification(
                        'admin',
                        'registration',
                        ' Late Registration',
                        `${player1Name} registered for ${event.name} (${Math.round(hoursUntilEvent)}h before tee time)`,
                        event.id
                    );
                }
                
                // Show success
                document.getElementById('registration-form-container').style.display = 'none';
                document.getElementById('modal-footer').style.display = 'none';
                
                // Build confirmation display with context-aware labels
                let rosterHTML = `<li><span>${player1Name}</span><span style="color: var(--gold);">You</span></li>`;
                filledMembers.forEach((m, i) => {
                    let label = '';
                    if (event.teamSize === 2 && i === 0) {
                        label = 'Partner';
                    } else if (event.teamSize === 2) {
                        label = 'Foursome';
                    } else if (event.teamSize === 3) {
                        label = 'Teammate';
                    } else if (event.teamSize === 4) {
                        label = 'Teammate';
                    } else {
                        label = 'Foursome';
                    }
                    rosterHTML += `<li><span>${m.name}</span><span>${label}</span></li>`;
                });
                
                const teeTimePrefDisplay = {
                    'no-preference': 'No Preference',
                    'first-off': 'First Off',
                    'earlier': 'Earlier Time',
                    'later': 'Later Time',
                    'last-off': 'Last Off'
                };
                
                // Build share message
                const shareText = `I registered us for ${event.name} on ${formatDate(event.date)}! Entry fee: $${event.entryFee}/player. Register and pay here:`;
                const shareUrl = window.location.href.split('?')[0]; // Current page URL
                
                const successContainer = document.getElementById('registration-success-container');
                successContainer.style.display = 'block';
                successContainer.innerHTML = `
                    <div class="registration-success">
                        <div class="success-icon"></div>
                        <h3>Registration Complete!</h3>
                        <p>You've been registered for ${event.name}</p>
                        <div class="confirmation-details">
                            <h4>Your Group</h4>
                            <ul class="team-list">
                                ${rosterHTML}
                            </ul>
                            <p style="margin-top: 1rem; font-size: 0.9rem;"><strong>Tee Time Preference:</strong> ${teeTimePrefDisplay[teeTimePref]}</p>
                            ${notes ? `<p style="font-size: 0.9rem;"><strong>Notes:</strong> ${notes}</p>` : ''}
                        </div>
                        <p style="font-size: 1.25rem; margin: 1rem 0;"><strong>Total Due: $${registration.total}</strong></p>
                        
                        <div class="payment-section">
                            <h4> Pay Your Entry Fee</h4>
                            <div class="payment-options">
                                <div class="payment-option">
                                    <div class="payment-logo"></div>
                                    <div class="payment-name">Venmo</div>
                                    <div class="payment-id">@IHMC-Golf</div>
                                </div>
                                <div class="payment-option">
                                    <div class="payment-logo"></div>
                                    <div class="payment-name">PayPal</div>
                                    <div class="payment-id">ihmc.golf@email.com</div>
                                </div>
                                <div class="payment-option">
                                    <div class="payment-logo"></div>
                                    <div class="payment-name">Zelle</div>
                                    <div class="payment-id">ihmc.golf@email.com</div>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 1rem; text-align: center;">
                                Include your name and event in the payment note
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="shareRegistration('${shareText.replace(/'/g, "\\'")}', '${shareUrl}')">
                                 Share with Group
                            </button>
                            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                        </div>
                    </div>
                `;
                
                // Update events display
                renderEvents();
                
                showToast('Registration successful!', 'success');
                
            } catch (error) {
                console.error('Registration error:', error);
                showToast('Registration saved! (offline mode)', 'success');
            }
            
            // Re-enable button
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Complete Registration';
        }

        // Render My Registrations
        function renderMyRegistrations() {
            const container = document.getElementById('my-registrations-list');
            
            if (myRegistrations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h4>No Registrations Yet</h4>
                        <p>Browse upcoming events and register your team!</p>
                    </div>
                `;
                return;
            }
            
            const teeTimePrefDisplay = {
                'no-preference': 'No Preference',
                'first-off': 'First Off',
                'earlier': 'Earlier Time',
                'later': 'Later Time',
                'last-off': 'Last Off'
            };
            
            container.innerHTML = myRegistrations.map((reg, index) => {
                const players = reg.players || [];
                const you = players[0] || 'You';
                const others = players.slice(1);
                
                return `
                    <div class="registration-card" style="flex-direction: column; align-items: stretch; gap: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                            <div class="registration-info">
                                <h4>${reg.eventName}</h4>
                                <p>${formatDate(reg.eventDate)}</p>
                            </div>
                            <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.85rem;" onclick="cancelRegistration(${index})">Cancel</button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.9rem;">
                            <div>
                                <strong style="color: var(--forest);">You:</strong> ${you}
                            </div>
                            ${others.length > 0 ? `
                                <div>
                                    <strong style="color: var(--forest);">Playing With:</strong> ${others.join(', ')}
                                </div>
                            ` : ''}
                            <div>
                                <strong style="color: var(--forest);">Tee Preference:</strong> ${teeTimePrefDisplay[reg.teeTimePref] || 'No Preference'}
                            </div>
                            <div>
                                <strong style="color: var(--forest);">Total:</strong> $${reg.total}
                            </div>
                        </div>
                        ${reg.notes ? `<div style="font-size: 0.85rem; color: var(--text-muted);"><strong>Notes:</strong> ${reg.notes}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Cancel Registration
        async function cancelRegistration(index) {
            const reg = myRegistrations[index];
            if (confirm(`Cancel registration for ${reg.eventName}?`)) {
                // Find the event and decrement registered count
                const event = events.find(e => e.id === reg.eventId);
                if (event && event.registeredTeams > 0) {
                    event.registeredTeams--;
                }
                
                // Create abbreviated event name (initials)
                let abbrev = '';
                if (reg.eventName === 'Sunday Scramble') {
                    abbrev = 'SS';
                } else {
                    abbrev = reg.eventName.split(' ').map(word => word[0].toUpperCase()).join('');
                }
                
                // Format tee time preference (blank if no preference)
                const teeTimePrefDisplay = {
                    'no-preference': '',
                    'first-off': 'First Off',
                    'earlier': 'Earlier',
                    'later': 'Later',
                    'last-off': 'Last Off'
                };
                
                // Send CANCELLED row to Google Sheets with strikethrough-style names
                try {
                    const cancellationData = {
                        event: 'CANCELLED - ' + abbrev,
                        eventDate: reg.eventDate,
                        player1: reg.players && reg.players[0] ? '~~' + reg.players[0] + '~~' : '',
                        player2: reg.players && reg.players[1] ? '~~' + reg.players[1] + '~~' : '',
                        player3: reg.players && reg.players[2] ? '~~' + reg.players[2] + '~~' : '',
                        player4: reg.players && reg.players[3] ? '~~' + reg.players[3] + '~~' : '',
                        entryFee: 0,
                        total: 0,
                        teeTimePref: teeTimePrefDisplay[reg.teeTimePref] || '',
                        notes: 'CANCELLED BY PLAYER'
                    };
                    
                    await fetch(GOOGLE_SHEETS_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(cancellationData)
                    });
                } catch (error) {
                    console.error('Error sending cancellation:', error);
                }
                
                // *** ADMIN NOTIFICATION FOR LATE CANCELLATION ***
                if (event) {
                    const eventDateTime = new Date(event.date + 'T' + (event.time || '07:20'));
                    const now = new Date();
                    const hoursUntilEvent = (eventDateTime - now) / (1000 * 60 * 60);
                    
                    if (hoursUntilEvent <= 24 && hoursUntilEvent > -24) {
                        createNotification(
                            'admin',
                            'cancellation',
                            ' Late Cancellation',
                            `${reg.players[0]} cancelled ${reg.eventName} (${Math.round(Math.abs(hoursUntilEvent))}h ${hoursUntilEvent > 0 ? 'before' : 'after'} tee time)`,
                            event.id
                        );
                    }
                }
                
                // Remove from local registrations
                myRegistrations.splice(index, 1);
                renderMyRegistrations();
                renderEvents();
                showToast('Registration cancelled - TD has been notified', 'success');
            }
        }

        // Share Registration
        async function shareRegistration(text, url) {
            const fullMessage = `${text}\n${url}`;
            
            // Try native share API first (mobile)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'IHMC Golf Registration',
                        text: text,
                        url: url
                    });
                    return;
                } catch (err) {
                    // User cancelled or share failed, fall through to clipboard
                }
            }
            
            // Fallback: copy to clipboard
            try {
                await navigator.clipboard.writeText(fullMessage);
                showToast('Copied to clipboard! Paste in your message.', 'success');
            } catch (err) {
                // Final fallback: show text to copy manually
                prompt('Copy this message to share:', fullMessage);
            }
        }

        // ============================================
        // MESSAGING SYSTEM
        // ============================================
        
        // Load messages from Firebase
        async function loadMessages() {
            if (!currentUser) return;
            
            try {
                const snapshot = await db.collection('messages')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                if (!snapshot.empty) {
                    messages = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    })).filter(msg => {
                        // Show messages where user is recipient (or all members)
                        if (msg.recipients === 'all') return true;
                        if (Array.isArray(msg.recipients) && msg.recipients.includes(currentUser.id)) return true;
                        // Also show messages user sent
                        if (msg.fromId === currentUser.id) return true;
                        return false;
                    });
                }
                updateMessageBadge();
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }
        
        // Update unread message badge
        function updateMessageBadge() {
            const btn = document.getElementById('messages-nav-btn');
            if (!btn || !currentUser) return;
            
            const unreadMsgCount = messages.filter(msg => {
                if (msg.fromId === currentUser.id) return false;
                const readMap = msg.readBy || {};
                return !readMap[currentUser.id];
            }).length;
            
            const unreadNotifCount = notifications.filter(n => !n.read).length;
            const totalUnread = unreadMsgCount + unreadNotifCount;
            
            if (totalUnread > 0) {
                btn.innerHTML = `Messages <span class="nav-badge">${totalUnread}</span>`;
            } else {
                btn.textContent = 'Messages';
            }
        }
        
        // Render messages view
        function renderMessages() {
            const container = document.getElementById('messages-content');
            const composeBtn = document.getElementById('compose-btn');
            
            if (!currentUser) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h4>Sign In Required</h4>
                        <p>Please sign in to view and send messages.</p>
                        <button class="btn btn-primary" onclick="openLoginModal()" style="margin-top: 1rem;">Sign In</button>
                    </div>
                `;
                composeBtn.style.display = 'none';
                return;
            }
            
            composeBtn.style.display = 'block';
            
            const unreadNotifCount = notifications.filter(n => !n.read).length;
            
            let html = `
                <div class="message-tabs">
                    <button class="message-tab ${currentMessageTab === 'notifications' ? 'active' : ''}" onclick="switchMessageTab('notifications')">
                        Notifications ${unreadNotifCount > 0 ? '<span class="message-badge">' + unreadNotifCount + '</span>' : ''}
                    </button>
                    <button class="message-tab ${currentMessageTab === 'inbox' ? 'active' : ''}" onclick="switchMessageTab('inbox')">
                        Inbox ${getUnreadCount() > 0 ? '<span class="message-badge">' + getUnreadCount() + '</span>' : ''}
                    </button>
                    <button class="message-tab ${currentMessageTab === 'sent' ? 'active' : ''}" onclick="switchMessageTab('sent')">Sent</button>
                </div>
            `;
            
            if (currentMessageTab === 'notifications') {
                // Render notifications in messages view
                if (notifications.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <h4>No Notifications</h4>
                            <p>You're all caught up!</p>
                        </div>
                    `;
                } else {
                    html += notifications.map(notif => {
                        const icon = getNotificationIcon(notif.type);
                        const time = notif.timestamp ? formatNotificationTime(notif.timestamp.toDate ? notif.timestamp.toDate() : new Date(notif.timestamp)) : '';
                        
                        return `
                            <div class="message-card ${notif.read ? '' : 'unread'}" 
                                 onclick="handleNotificationClickFromMessages('${notif.id}', '${notif.type}', '${notif.linkId || ''}')">
                                <div class="message-header">
                                    <span class="message-from">${icon} ${escapeHtml(notif.title)}</span>
                                    <span class="message-date">${time}</span>
                                </div>
                                <div class="message-preview">${escapeHtml(notif.body)}</div>
                            </div>
                        `;
                    }).join('');
                    
                    if (notifications.some(n => !n.read)) {
                        html += `<button class="btn btn-outline" style="margin-top: 1rem; width: 100%;" onclick="markAllNotificationsRead(); renderMessages();">Mark All Read</button>`;
                    }
                }
            } else {
                // Render messages (inbox or sent)
                let filteredMessages = [];
                if (currentMessageTab === 'inbox') {
                    filteredMessages = messages.filter(msg => msg.fromId !== currentUser.id);
                } else {
                    filteredMessages = messages.filter(msg => msg.fromId === currentUser.id);
                }
                
                if (filteredMessages.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <h4>No Messages</h4>
                            <p>${currentMessageTab === 'inbox' ? 'Your inbox is empty.' : "You haven't sent any messages yet."}</p>
                        </div>
                    `;
                } else {
                    html += filteredMessages.map(msg => {
                        const isUnread = currentMessageTab === 'inbox' && !(msg.readBy && msg.readBy[currentUser.id]);
                        const fromName = msg.fromId === currentUser.id ? 'You' : (msg.fromName || 'Unknown');
                        const toDisplay = msg.recipients === 'all' ? 'All Members' : 
                            (Array.isArray(msg.recipientNames) ? msg.recipientNames.join(', ') : 'Member');
                        const displayName = currentMessageTab === 'inbox' ? fromName : `To: ${toDisplay}`;
                        const preview = msg.body.substring(0, 80) + (msg.body.length > 80 ? '...' : '');
                        const date = msg.timestamp ? formatMessageDate(msg.timestamp.toDate ? msg.timestamp.toDate() : new Date(msg.timestamp)) : '';
                        
                        return `
                            <div class="message-card ${isUnread ? 'unread' : ''}" onclick="viewMessage('${msg.id}')">
                                <div class="message-header">
                                    <span class="message-from">${displayName}</span>
                                    <span class="message-date">${date}</span>
                                </div>
                                <div class="message-subject">${msg.subject || '(No Subject)'}</div>
                                <div class="message-preview">${preview}</div>
                            </div>
                        `;
                    }).join('');
                }
            }
            
            container.innerHTML = html;
        }
        
        // Handle notification click from messages view
        async function handleNotificationClickFromMessages(notifId, type, linkId) {
            const notif = notifications.find(n => n.id === notifId);
            if (notif && !notif.read) {
                try {
                    await db.collection('notifications').doc(notifId).update({ read: true });
                    notif.read = true;
                    updateNotificationBadge();
                    updateNotificationBellVisibility();
                } catch (error) {
                    console.error('Error marking notification read:', error);
                }
            }
            
            // Navigate based on type
            if (type === 'message' && linkId) {
                switchMessageTab('inbox');
                // Could also open the specific message
            } else if (type === 'registration') {
                document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
                document.querySelector('[data-view="my-registrations"]').classList.add('active');
                document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
                document.getElementById('my-registrations-view').style.display = 'block';
                renderMyRegistrations();
            } else {
                renderMessages();
            }
        }
        
        function getUnreadCount() {
            if (!currentUser) return 0;
            return messages.filter(msg => {
                if (msg.fromId === currentUser.id) return false;
                const readMap = msg.readBy || {};
                return !readMap[currentUser.id];
            }).length;
        }
        
        function switchMessageTab(tab) {
            currentMessageTab = tab;
            renderMessages();
        }
        
        function formatMessageDate(date) {
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) {
                return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else if (days === 1) {
                return 'Yesterday';
            } else if (days < 7) {
                return date.toLocaleDateString('en-US', { weekday: 'short' });
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }
        
        // View a message
        async function viewMessage(messageId) {
            const msg = messages.find(m => m.id === messageId);
            if (!msg) return;
            
            currentViewingMessage = msg;
            
            // Mark as read if it's in inbox
            if (msg.fromId !== currentUser.id && !(msg.readBy && msg.readBy[currentUser.id])) {
                try {
                    await db.collection('messages').doc(messageId).update({
                        [`readBy.${currentUser.id}`]: true
                    });
                    if (!msg.readBy) msg.readBy = {};
                    msg.readBy[currentUser.id] = true;
                    updateMessageBadge();
                    renderMessages();
                } catch (error) {
                    console.error('Error marking message read:', error);
                }
            }
            
            // Populate modal
            document.getElementById('view-message-subject').textContent = msg.subject || '(No Subject)';
            const fromName = msg.fromName || 'Unknown';
            const date = msg.timestamp ? new Date(msg.timestamp.toDate ? msg.timestamp.toDate() : msg.timestamp).toLocaleString() : '';
            document.getElementById('view-message-meta').textContent = `From: ${fromName}  ${date}`;
            document.getElementById('view-message-body').textContent = msg.body;
            
            // Show/hide reply button
            document.getElementById('reply-btn').style.display = msg.fromId !== currentUser.id ? 'block' : 'none';
            
            document.getElementById('view-message-modal').classList.add('active');
        }
        
        function closeViewMessageModal() {
            document.getElementById('view-message-modal').classList.remove('active');
            currentViewingMessage = null;
        }
        
        function replyToMessage() {
            if (!currentViewingMessage) return;
            closeViewMessageModal();
            openComposeModal();
            
            // Pre-fill recipient
            selectedRecipients = [{ id: currentViewingMessage.fromId, name: currentViewingMessage.fromName }];
            document.getElementById('compose-recipient-type').value = 'individual';
            handleRecipientTypeChange();
            document.getElementById('compose-recipient-search').value = currentViewingMessage.fromName;
            
            // Pre-fill subject with Re:
            const subject = currentViewingMessage.subject || '';
            document.getElementById('compose-subject').value = subject.startsWith('Re:') ? subject : `Re: ${subject}`;
        }
        
        // Compose modal functions
        function openComposeModal() {
            if (!currentUser) {
                showToast('Please sign in to send messages', 'error');
                return;
            }
            
            // Reset form
            document.getElementById('compose-recipient-type').value = 'individual';
            document.getElementById('compose-recipient-search').value = '';
            document.getElementById('compose-subject').value = '';
            document.getElementById('compose-body').value = '';
            selectedRecipients = [];
            
            handleRecipientTypeChange();
            document.getElementById('compose-modal').classList.add('active');
        }
        
        function closeComposeModal() {
            document.getElementById('compose-modal').classList.remove('active');
        }
        
        function handleRecipientTypeChange() {
            const type = document.getElementById('compose-recipient-type').value;
            const individualGroup = document.getElementById('individual-recipient-group');
            const groupGroup = document.getElementById('group-recipient-group');
            
            if (type === 'individual') {
                individualGroup.style.display = 'block';
                groupGroup.style.display = 'none';
            } else if (type === 'group') {
                individualGroup.style.display = 'none';
                groupGroup.style.display = 'block';
                populateGroupRecipients();
            } else {
                individualGroup.style.display = 'none';
                groupGroup.style.display = 'none';
            }
        }
        
        function populateGroupRecipients() {
            const container = document.getElementById('group-recipient-list');
            const sortedMembers = [...memberDirectory].sort((a, b) => a.name.localeCompare(b.name));
            
            container.innerHTML = sortedMembers.map(m => `
                <div class="recipient-checkbox">
                    <input type="checkbox" id="recipient-${m.id}" value="${m.id}" onchange="updateSelectedCount()">
                    <label for="recipient-${m.id}">${m.name}</label>
                </div>
            `).join('');
            
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('#group-recipient-list input:checked');
            document.getElementById('selected-count').textContent = checkboxes.length;
        }
        
        function showComposeRecipientDropdown() {
            const dropdown = document.getElementById('compose-recipient-dropdown');
            filterComposeRecipients();
            dropdown.classList.add('active');
        }
        
        function filterComposeRecipients() {
            const input = document.getElementById('compose-recipient-search');
            const dropdown = document.getElementById('compose-recipient-dropdown');
            const filter = input.value.toLowerCase();
            
            const filtered = memberDirectory
                .filter(m => m.name.toLowerCase().includes(filter) && m.id !== currentUser.id)
                .sort((a, b) => a.name.localeCompare(b.name));
            
            dropdown.innerHTML = filtered.slice(0, 10).map(m => `
                <div class="member-option" onclick="selectComposeRecipient('${m.id}', '${m.name}')">
                    <div class="name">${m.name}</div>
                </div>
            `).join('');
            
            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="member-option"><div class="name" style="color: var(--text-muted);">No members found</div></div>';
            }
        }
        
        function selectComposeRecipient(id, name) {
            selectedRecipients = [{ id, name }];
            document.getElementById('compose-recipient-search').value = name;
            document.getElementById('compose-recipient-dropdown').classList.remove('active');
        }
        
        // Send message
        async function sendMessage() {
            const type = document.getElementById('compose-recipient-type').value;
            const subject = document.getElementById('compose-subject').value.trim();
            const body = document.getElementById('compose-body').value.trim();
            
            if (!body) {
                showToast('Please enter a message', 'error');
                return;
            }
            
            let recipients = [];
            let recipientNames = [];
            
            if (type === 'individual') {
                if (selectedRecipients.length === 0) {
                    showToast('Please select a recipient', 'error');
                    return;
                }
                recipients = selectedRecipients.map(r => r.id);
                recipientNames = selectedRecipients.map(r => r.name);
            } else if (type === 'group') {
                const checkboxes = document.querySelectorAll('#group-recipient-list input:checked');
                if (checkboxes.length === 0) {
                    showToast('Please select at least one recipient', 'error');
                    return;
                }
                checkboxes.forEach(cb => {
                    const member = memberDirectory.find(m => m.id === cb.value);
                    if (member) {
                        recipients.push(member.id);
                        recipientNames.push(member.name);
                    }
                });
            } else {
                recipients = 'all';
                recipientNames = ['All Members'];
            }
            
            const message = {
                fromId: currentUser.id,
                fromName: currentUser.name,
                recipients: recipients,
                recipientNames: recipientNames,
                subject: subject || '(No Subject)',
                body: body,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                readBy: {}
            };
            
            try {
                const docRef = await db.collection('messages').add(message);
                message.id = docRef.id;
                message.timestamp = new Date();
                messages.unshift(message);
                
                // Create notifications for recipients
                const notifTitle = 'New Message';
                const notifBody = `${currentUser.name}: ${subject || body.substring(0, 50)}`;
                
                if (recipients === 'all') {
                    // For "all" messages, use batch notification for efficiency
                    const recipientIds = memberDirectory
                        .filter(m => m.id !== currentUser.id)
                        .map(m => m.id);
                    createNotificationsBatch(recipientIds, 'message', notifTitle, notifBody, docRef.id);
                } else {
                    // Individual/group message notifications - use batch for groups
                    if (recipients.length > 3) {
                        createNotificationsBatch(recipients, 'message', notifTitle, notifBody, docRef.id);
                    } else {
                        for (const recipientId of recipients) {
                            createNotification(recipientId, 'message', notifTitle, notifBody, docRef.id);
                        }
                    }
                }
                
                closeComposeModal();
                showToast('Message sent!', 'success');
                renderMessages();
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Error sending message', 'error');
            }
        }
        
        // Close compose dropdown on outside click
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('compose-recipient-dropdown');
            const input = document.getElementById('compose-recipient-search');
            if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
                dropdown.classList.remove('active');
            }
        });

        // ============================================
        // NOTIFICATION SYSTEM
        // ============================================
        
        let notifications = [];
        
        // Load notifications from Firebase
        async function loadNotifications() {
            if (!currentUser) return;
            
            try {
                const snapshot = await db.collection('notifications')
                    .where('userId', '==', currentUser.id)
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();
                
                notifications = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                updateNotificationBadge();
                renderNotifications();
            } catch (error) {
                console.error('Error loading notifications:', error);
                // Check if it's a missing index error
                if (error.code === 'failed-precondition' && error.message.includes('index')) {
                    console.warn('Firebase index required for notifications. Check console for index creation link.');
                    // Fallback: try without orderBy (less efficient but works without index)
                    try {
                        const fallbackSnapshot = await db.collection('notifications')
                            .where('userId', '==', currentUser.id)
                            .limit(20)
                            .get();
                        notifications = fallbackSnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        })).sort((a, b) => {
                            const timeA = a.timestamp?.toDate?.() || new Date(0);
                            const timeB = b.timestamp?.toDate?.() || new Date(0);
                            return timeB - timeA;
                        });
                        updateNotificationBadge();
                        renderNotifications();
                    } catch (fallbackError) {
                        console.error('Fallback notification load also failed:', fallbackError);
                    }
                }
            }
        }
        
        // Update notification badge and bell visibility
        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            const bell = document.getElementById('notification-bell');
            if (!badge) return;
            
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.style.display = 'flex';
                if (bell) bell.style.display = 'block';
            } else {
                badge.style.display = 'none';
                if (bell) bell.style.display = 'none';
            }
        }
        
        // Separate function to update bell visibility
        function updateNotificationBellVisibility() {
            const bell = document.getElementById('notification-bell');
            if (!bell) return;
            
            const unreadCount = notifications.filter(n => !n.read).length;
            bell.style.display = unreadCount > 0 ? 'block' : 'none';
        }
        
        // Toggle notification dropdown
        function toggleNotifications(event) {
            if (event) {
                event.stopPropagation();
            }
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.classList.toggle('active');
            
            if (dropdown.classList.contains('active')) {
                renderNotifications();
            }
        }
        
        // Render notifications list
        function renderNotifications() {
            const container = document.getElementById('notification-list');
            
            if (!currentUser) {
                container.innerHTML = '<div class="notification-empty">Sign in to see notifications</div>';
                return;
            }
            
            if (notifications.length === 0) {
                container.innerHTML = '<div class="notification-empty">No notifications yet</div>';
                return;
            }
            
            container.innerHTML = notifications.map(notif => {
                const icon = getNotificationIcon(notif.type);
                const time = notif.timestamp ? formatNotificationTime(notif.timestamp.toDate ? notif.timestamp.toDate() : new Date(notif.timestamp)) : '';
                
                return `
                    <div class="notification-item ${notif.read ? '' : 'unread'}" 
                         data-notif-id="${escapeAttr(notif.id)}" 
                         data-notif-type="${escapeAttr(notif.type || '')}" 
                         data-notif-link="${escapeAttr(notif.linkId || '')}"
                         onclick="handleNotificationClick(this.dataset.notifId, this.dataset.notifType, this.dataset.notifLink)">
                        <span class="notif-icon">${icon}</span>
                        <div class="notif-content">
                            <div class="notif-title">${escapeHtml(notif.title)}</div>
                            <div class="notif-body">${escapeHtml(notif.body)}</div>
                            <div class="notif-time">${time}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getNotificationIcon(type) {
            switch(type) {
                case 'message': return '';
                case 'registration': return '';
                case 'cancellation': return '';
                case 'reminder': return '';
                default: return '';
            }
        }
        
        function formatNotificationTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        // Handle notification click
        async function handleNotificationClick(notifId, type, linkId) {
            // Mark as read
            const notif = notifications.find(n => n.id === notifId);
            if (notif && !notif.read) {
                try {
                    await db.collection('notifications').doc(notifId).update({ read: true });
                    notif.read = true;
                    updateNotificationBadge();
                } catch (error) {
                    console.error('Error marking notification read:', error);
                }
            }
            
            // Navigate based on type
            if (type === 'message') {
                document.getElementById('notification-dropdown').classList.remove('active');
                document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
                document.querySelector('[data-view="messages"]').classList.add('active');
                document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
                document.getElementById('messages-view').style.display = 'block';
                renderMessages();
            } else if (type === 'registration') {
                document.getElementById('notification-dropdown').classList.remove('active');
                document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
                document.querySelector('[data-view="my-registrations"]').classList.add('active');
                document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
                document.getElementById('my-registrations-view').style.display = 'block';
                renderMyRegistrations();
            }
        }
        
        // Mark all notifications as read
        async function markAllNotificationsRead() {
            const unreadNotifs = notifications.filter(n => !n.read);
            
            try {
                const batch = db.batch();
                unreadNotifs.forEach(notif => {
                    const ref = db.collection('notifications').doc(notif.id);
                    batch.update(ref, { read: true });
                    notif.read = true;
                });
                await batch.commit();
                updateNotificationBadge();
                renderNotifications();
            } catch (error) {
                console.error('Error marking all read:', error);
            }
        }
        
        // Create notification (helper function)
        async function createNotification(userId, type, title, body, linkId = null) {
            try {
                await db.collection('notifications').add({
                    userId: userId,
                    type: type,
                    title: title,
                    body: body,
                    linkId: linkId,
                    read: false,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error creating notification:', error);
            }
        }
        
        // Create notifications for multiple users efficiently using batched writes
        async function createNotificationsBatch(userIds, type, title, body, linkId = null) {
            if (!userIds || userIds.length === 0) return;
            
            try {
                // Firestore batches are limited to 500 operations
                const batchSize = 500;
                for (let i = 0; i < userIds.length; i += batchSize) {
                    const batch = db.batch();
                    const chunk = userIds.slice(i, i + batchSize);
                    
                    chunk.forEach(userId => {
                        const ref = db.collection('notifications').doc();
                        batch.set(ref, {
                            userId: userId,
                            type: type,
                            title: title,
                            body: body,
                            linkId: linkId,
                            read: false,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    
                    await batch.commit();
                }
            } catch (error) {
                console.error('Error creating batch notifications:', error);
            }
        }
        
        // Close notification dropdown on outside click
        document.addEventListener('click', (e) => {
            const profileBellGroup = document.querySelector('.profile-bell-group');
            const dropdown = document.getElementById('notification-dropdown');
            if (profileBellGroup && dropdown && !profileBellGroup.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });

        // ============================================
        // INFO PAGE FUNCTIONS
        // ============================================
        
        // Pay Dues Modal
        function openPayDuesModal() {
            document.getElementById('pay-dues-modal').classList.add('active');
        }
        
        function closePayDuesModal() {
            document.getElementById('pay-dues-modal').classList.remove('active');
        }
        
        // Local Rules Modal
        function showLocalRules() {
            document.getElementById('local-rules-modal').classList.add('active');
        }
        
        function closeLocalRulesModal() {
            document.getElementById('local-rules-modal').classList.remove('active');
        }
        
        // Bylaws Modal
        function showBylaws() {
            document.getElementById('bylaws-modal').classList.add('active');
        }
        
        function closeBylawsModal() {
            document.getElementById('bylaws-modal').classList.remove('active');
        }
        
        // Contact/Suggestion Form
        document.getElementById('contact-category')?.addEventListener('change', function() {
            const anonymousOption = document.getElementById('anonymous-option');
            if (this.value === 'suggestion') {
                anonymousOption.style.display = 'block';
            } else {
                anonymousOption.style.display = 'none';
                document.getElementById('contact-anonymous').checked = false;
            }
        });
        
        // Admin role assignments (will be updated with actual GHINs)
        const ADMIN_ROLES = {
            tournament: '9642645',   // Tournament Director - Mike Haskins (placeholder)
            membership: '9329109',   // Membership Chair - Chuck Bischoff (placeholder)
            dues: '9074433',         // Treasurer - Eli Montoya (placeholder)
            general: '9329109',      // President - Chuck Bischoff (placeholder)
            suggestion: '9329109'    // President - Chuck Bischoff (placeholder)
        };
        
        async function submitContactForm() {
            const category = document.getElementById('contact-category').value;
            const message = document.getElementById('contact-message').value.trim();
            const isAnonymous = document.getElementById('contact-anonymous')?.checked;
            
            if (!category) {
                showToast('Please select a category', 'error');
                return;
            }
            
            if (!message) {
                showToast('Please enter a message', 'error');
                return;
            }
            
            // Find the admin for this category
            const adminGhin = ADMIN_ROLES[category];
            const adminMember = memberDirectory.find(m => m.ghin === adminGhin);
            
            if (!adminMember) {
                showToast('Error finding recipient. Please try again.', 'error');
                return;
            }
            
            const categoryLabels = {
                tournament: 'Tournament/Events',
                membership: 'Membership',
                dues: 'Dues/Payments',
                general: 'General Question',
                suggestion: 'Suggestion'
            };
            
            const fromName = isAnonymous ? 'Anonymous' : (currentUser?.name || 'Guest');
            const fromId = isAnonymous ? 'anonymous' : (currentUser?.id || 'guest');
            
            const contactMessage = {
                fromId: fromId,
                fromName: fromName,
                recipients: [adminMember.id],
                recipientNames: [adminMember.name],
                subject: `[${categoryLabels[category]}] Contact Form Submission`,
                body: message,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                readBy: {},
                isContactForm: true,
                category: category
            };
            
            try {
                const docRef = await db.collection('messages').add(contactMessage);
                
                // Create notification for admin
                createNotification(
                    adminMember.id,
                    'message',
                    `New ${categoryLabels[category]} Inquiry`,
                    `${fromName}: ${message.substring(0, 50)}...`,
                    docRef.id
                );
                
                // Reset form
                document.getElementById('contact-category').value = '';
                document.getElementById('contact-message').value = '';
                document.getElementById('contact-anonymous').checked = false;
                document.getElementById('anonymous-option').style.display = 'none';
                
                showToast('Message sent! You\'ll hear back soon.', 'success');
            } catch (error) {
                console.error('Error sending contact form:', error);
                showToast('Error sending message. Please try again.', 'error');
            }
        }
        
        // ============================================
        // CALENDAR FUNCTIONS
        // ============================================
        
        let currentCalendarDate = new Date(2026, 0, 1); // January 2026
        let isCalendarView = false;
        
        // Toggle between list and calendar view on Events page
        function toggleEventsView() {
            isCalendarView = !isCalendarView;
            const listView = document.getElementById('events-list-view');
            const calendarView = document.getElementById('events-calendar-view');
            const toggleBtn = document.getElementById('calendar-toggle-btn');
            
            if (isCalendarView) {
                listView.style.display = 'none';
                calendarView.style.display = 'block';
                toggleBtn.innerHTML = ' List View';
                renderCalendar();
            } else {
                listView.style.display = 'block';
                calendarView.style.display = 'none';
                toggleBtn.innerHTML = ' Calendar View';
            }
        }
        
        function changeCalendarMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }
        
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const titleEl = document.getElementById('calendar-month-title');
            
            if (!grid || !titleEl) return;
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            titleEl.textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and total days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            // Get today for highlighting
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            
            // Get events for this month
            const monthEvents = events.filter(e => {
                const [eYear, eMonth] = e.date.split('-').map(Number);
                return eYear === year && eMonth === month + 1;
            });
            
            let html = '';
            
            // Day headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div class="calendar-header">${day}</div>`;
            });
            
            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                html += `<div class="calendar-day other-month"><span class="day-number">${day}</span></div>`;
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEvents = monthEvents.filter(e => e.date === dateStr);
                const isToday = isCurrentMonth && today.getDate() === day;
                const hasEvent = dayEvents.length > 0;
                
                let eventsHtml = '';
                dayEvents.forEach(event => {
                    // Scramble = forest (green), Tournament = gold
                    const typeClass = event.type === 'scramble' ? 'scramble' : 'tournament';
                    // Show full name, will wrap in cell
                    const displayName = event.name === 'Sunday Scramble' ? 'Sunday Scramble' : event.name;
                    eventsHtml += `<div class="calendar-event ${typeClass}" onclick="event.stopPropagation(); openModal('${event.id}')">${displayName}</div>`;
                });
                
                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''} ${hasEvent ? 'has-event' : ''}">
                        <span class="day-number">${day}</span>
                        <div class="day-events">${eventsHtml}</div>
                    </div>
                `;
            }
            
            // Next month days
            const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;
            const remainingCells = totalCells - (firstDay + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                html += `<div class="calendar-day other-month"><span class="day-number">${day}</span></div>`;
            }
            
            grid.innerHTML = html;
        }
        
        // ============================================
        // COURSE INFO FUNCTIONS
        // ============================================
        
        function copyAddress() {
            const address = '5700 Club House Dr, Riverside, CA 92509';
            navigator.clipboard.writeText(address).then(() => {
                showToast('Address copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = address;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Address copied to clipboard!', 'success');
            });
        }

        // Utility Functions
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Escape for use in HTML attributes (onclick handlers, etc.)
        function escapeAttr(text) {
            if (!text) return '';
            return text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }
        
        function formatDate(dateStr) {
            // Parse date parts to avoid timezone issues
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day); // month is 0-indexed
            return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        }

        function formatTime(timeStr) {
            const [hours, minutes] = timeStr.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${minutes} ${ampm}`;
        }

        function formatName(str) {
            return str.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                ${type === 'success' ? '' : ''} ${message}
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Close modal on overlay click
        document.getElementById('registration-modal').addEventListener('click', (e) => {
            if (e.target.id === 'registration-modal') {
                closeModal();
            }
        });

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
